# Chat Dialogue Log

## å¯¹è¯æ—¶é—´
2025-10-19 16:05:42

---

## å¯¹è¯å†…å®¹

### é—®é¢˜ 1
ç”¨æˆ·ï¼šsearch_r1/searchæ–‡ä»¶å¤¹ä¸‹æœ‰å¥½å‡ ä»½æ–‡ä»¶ï¼Œè¯·æŒ‰ç…§åŠŸèƒ½è¿›è¡Œåˆ†ç±»ï¼Œå¹¶æ€»ç»“å…¶æ ¸å¿ƒä½œç”¨ï¼
åŠ©æ‰‹ï¼šæˆ‘æ¥åˆ†æsearch_r1/searchæ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶å¹¶æŒ‰ç…§åŠŸèƒ½è¿›è¡Œåˆ†ç±»ã€‚

é¦–å…ˆè®©æˆ‘åˆ—å‡ºè¯¥æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼š

search_r1/searchæ–‡ä»¶å¤¹åŒ…å«11ä¸ªæ–‡ä»¶ï¼ŒæŒ‰ç…§åŠŸèƒ½å¯åˆ†ä¸º4å¤§ç±»ï¼š

### 1. æ ¸å¿ƒæ£€ç´¢æ¨¡å— (Core Retrieval Components)

**retrieval.py** - æ ¸å¿ƒæ£€ç´¢å¼•æ“å®ç°
- **åŠŸèƒ½**: åŸºç¡€æ£€ç´¢ç³»ç»Ÿçš„æ ¸å¿ƒå®ç°
- **æ ¸å¿ƒç±»**:
  - `BaseRetriever`: æ£€ç´¢å™¨åŸºç±»
  - `BM25Retriever`: BM25ç¨€ç–æ£€ç´¢å™¨ï¼ŒåŸºäºPyserini
  - `DenseRetriever`: å¯†é›†æ£€ç´¢å™¨ï¼ŒåŸºäºFAISSå’ŒTransformerç¼–ç å™¨
  - `Encoder`: æ–‡æœ¬ç¼–ç å™¨ï¼Œæ”¯æŒE5ã€BGEç­‰æ¨¡å‹
- **ä½œç”¨**: æä¾›ç»Ÿä¸€çš„æ£€ç´¢æ¥å£ï¼Œæ”¯æŒå¤šç§æ£€ç´¢æ–¹æ³•

**index_builder.py** - ç´¢å¼•æ„å»ºå·¥å…·
- **åŠŸèƒ½**: æ„å»ºå„ç§ç±»å‹çš„æ£€ç´¢ç´¢å¼•
- **æ ¸å¿ƒç‰¹æ€§**:
  - æ”¯æŒBM25ç´¢å¼•æ„å»ºï¼ˆåŸºäºPyseriniï¼‰
  - æ”¯æŒå¯†é›†å‘é‡ç´¢å¼•æ„å»ºï¼ˆåŸºäºFAISSï¼‰
  - æ”¯æŒå¤šç§FAISSç´¢å¼•ç±»å‹ï¼ˆFlatã€HNSWç­‰ï¼‰
  - æ”¯æŒGPUåŠ é€Ÿå’Œæ‰¹å¤„ç†
- **ä½œç”¨**: å°†è¯­æ–™åº“è½¬æ¢ä¸ºå¯æ£€ç´¢çš„ç´¢å¼•æ–‡ä»¶

### 2. æœåŠ¡å™¨æ¨¡å— (Server Components)

**retrieval_server.py** - æ£€ç´¢æœåŠ¡å™¨
- **åŠŸèƒ½**: åŸºäºFastAPIçš„æ£€ç´¢æœåŠ¡
- **æ ¸å¿ƒç‰¹æ€§**:
  - æä¾›HTTP APIæ¥å£ `/retrieve`
  - æ”¯æŒæ‰¹é‡æŸ¥è¯¢æ£€ç´¢
  - æ”¯æŒBM25å’Œå¯†é›†æ£€ç´¢
  - å†…å­˜ç®¡ç†å’ŒGPUåŠ é€Ÿ
- **ä½œç”¨**: å°†æ£€ç´¢åŠŸèƒ½å°è£…ä¸ºç½‘ç»œæœåŠ¡ï¼Œæ”¯æŒè¿œç¨‹è°ƒç”¨

**google_search_server.py** - Googleæœç´¢æœåŠ¡å™¨
- **åŠŸèƒ½**: åœ¨çº¿Googleæœç´¢ä»£ç†æœåŠ¡
- **æ ¸å¿ƒç‰¹æ€§**:
  - é›†æˆGoogle Custom Search API
  - æ”¯æŒç½‘é¡µå†…å®¹æŠ“å–å’Œå¤„ç†
  - æ”¯æŒä»…æ‘˜è¦æ¨¡å¼æˆ–å…¨æ–‡æ¨¡å¼
  - å¼‚æ­¥å¹¶å‘è¯·æ±‚å¤„ç†
- **ä½œç”¨**: æä¾›å®æ—¶ç½‘ç»œæœç´¢èƒ½åŠ›

**serp_search_server.py** - SERPAPIæœç´¢æœåŠ¡å™¨
- **åŠŸèƒ½**: åŸºäºSerpAPIçš„åœ¨çº¿æœç´¢æœåŠ¡
- **æ ¸å¿ƒç‰¹æ€§**:
  - æ”¯æŒå¤šç§æœç´¢å¼•æ“ï¼ˆGoogleã€Bingç­‰ï¼‰
  - å¤„ç†æœç´¢ç»“æœã€ç­”æ¡ˆæ¡†ã€ç›¸å…³é—®é¢˜
  - ç»Ÿä¸€çš„APIæ¥å£æ ¼å¼
- **ä½œç”¨**: æä¾›æ ‡å‡†åŒ–çš„åœ¨çº¿æœç´¢æ¥å£

**rerank_server.py** - é‡æ’åºæœåŠ¡å™¨
- **åŠŸèƒ½**: æ–‡æ¡£é‡æ’åºæœåŠ¡
- **æ ¸å¿ƒç‰¹æ€§**:
  - åŸºäºCrossEncoderæ¨¡å‹è¿›è¡Œé‡æ’åº
  - æ”¯æŒæ‰¹é‡å¤„ç†
  - å¯é…ç½®topkç»“æœæ•°é‡
- **ä½œç”¨**: å¯¹åˆæ­¥æ£€ç´¢ç»“æœè¿›è¡Œç²¾ç»†é‡æ’åº

**retrieval_rerank_server.py** - æ£€ç´¢ä¸é‡æ’åºä¸€ä½“åŒ–æœåŠ¡å™¨
- **åŠŸèƒ½**: é›†æˆæ£€ç´¢å’Œé‡æ’åºçš„å®Œæ•´æœåŠ¡
- **æ ¸å¿ƒç‰¹æ€§**:
  - å…ˆæ£€ç´¢åé‡æ’åºçš„ä¸¤é˜¶æ®µæµç¨‹
  - ç»Ÿä¸€çš„APIæ¥å£
  - ç»“æœæ ¼å¼è½¬æ¢å’Œä¼˜åŒ–
- **ä½œç”¨**: æä¾›å®Œæ•´çš„æ£€ç´¢-é‡æ’åºæµæ°´çº¿æœåŠ¡

### 3. è¾…åŠ©å·¥å…·æ¨¡å— (Utility Tools)

**retrieval_request.py** - å®¢æˆ·ç«¯è¯·æ±‚ç¤ºä¾‹
- **åŠŸèƒ½**: æ¼”ç¤ºå¦‚ä½•è°ƒç”¨æ£€ç´¢æœåŠ¡å™¨
- **ä½œç”¨**: æä¾›APIè°ƒç”¨çš„ç¤ºä¾‹ä»£ç 

### 4. è„šæœ¬æ–‡ä»¶ (Script Files)

**build_index.sh** - ç´¢å¼•æ„å»ºè„šæœ¬
- **åŠŸèƒ½**: ç´¢å¼•æ„å»ºçš„Shellè„šæœ¬å°è£…
- **é…ç½®é¡¹**: è¯­æ–™è·¯å¾„ã€æ¨¡å‹è·¯å¾„ã€FAISSç±»å‹ç­‰
- **ä½œç”¨**: ç®€åŒ–ç´¢å¼•æ„å»ºæµç¨‹ï¼Œæä¾›æ ‡å‡†é…ç½®

**retrieval.sh** - æ‰¹é‡æ£€ç´¢è„šæœ¬
- **åŠŸèƒ½**: æ‰¹é‡æ•°æ®é›†æ£€ç´¢çš„Shellè„šæœ¬
- **åº”ç”¨åœºæ™¯**: åœ¨NQç­‰æ•°æ®é›†ä¸Šè¿›è¡Œæ‰¹é‡æ£€ç´¢è¯„ä¼°
- **ä½œç”¨**: æ”¯æŒå¤§è§„æ¨¡æ•°æ®é›†çš„æ‰¹é‡æ£€ç´¢å¤„ç†

---

### é—®é¢˜ 2
ç”¨æˆ·ï¼šæˆ‘è§‰å¾—ä½ çš„åˆ†ç±»æ–¹æ³•ä¸æ˜¯å¾ˆå¥½ã€‚è¯·æŒ‰ç…§ç›¸åŒçš„åŠŸèƒ½è¿›è¡Œåˆ†ç±»ï¼Œæ¯”å¦‚æ£€ç´¢ç±»ã€æ’åºç±»ï¼ˆç¦»çº¿å¤„ç†å’Œåœ¨çº¿å¤„ç†ä¸åº”è¯¥ä½œä¸ºåˆ†ç±»æ ‡å‡†ï¼‰
åŠ©æ‰‹ï¼šä½ è¯´å¾—å¯¹ï¼Œæˆ‘é‡æ–°æŒ‰ç…§åŠŸèƒ½æ¥åˆ†ç±»è¿™äº›æ–‡ä»¶ã€‚è®©æˆ‘é‡æ–°åˆ†æï¼š

## search_r1/search æ–‡ä»¶æŒ‰åŠŸèƒ½é‡æ–°åˆ†ç±»

### 1. æ£€ç´¢åŠŸèƒ½æ¨¡å— (Retrieval)

**retrieval.py** - æ ¸å¿ƒæ£€ç´¢å¼•æ“
- **åŠŸèƒ½**: å®ç°åŸºç¡€çš„æ£€ç´¢ç®—æ³•
- **åŒ…å«**: BM25Retrieverã€DenseRetrieverã€Encoderç­‰æ ¸å¿ƒç±»
- **ä½œç”¨**: æä¾›æœ¬åœ°æ–‡æ¡£æ£€ç´¢èƒ½åŠ›

**retrieval_server.py** - æ£€ç´¢APIæœåŠ¡
- **åŠŸèƒ½**: å°†æ£€ç´¢åŠŸèƒ½å°è£…ä¸ºHTTP APIæœåŠ¡
- **æ¥å£**: `/retrieve` ç«¯ç‚¹
- **ä½œç”¨**: æä¾›ç½‘ç»œåŒ–çš„æ£€ç´¢æœåŠ¡æ¥å£

**retrieval_request.py** - æ£€ç´¢è¯·æ±‚ç¤ºä¾‹
- **åŠŸèƒ½**: æ¼”ç¤ºå¦‚ä½•è°ƒç”¨æ£€ç´¢API
- **ä½œç”¨**: æ£€ç´¢æœåŠ¡çš„å®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹

### 2. æœç´¢åŠŸèƒ½æ¨¡å— (Search)

**google_search_server.py** - Googleæœç´¢å¼•æ“
- **åŠŸèƒ½**: é›†æˆGoogle Custom Search API
- **ç‰¹æ€§**: æ”¯æŒç½‘é¡µå†…å®¹æŠ“å–ã€å¼‚æ­¥è¯·æ±‚å¤„ç†
- **ä½œç”¨**: æä¾›å®æ—¶ç½‘ç»œæœç´¢èƒ½åŠ›

**serp_search_server.py** - é€šç”¨æœç´¢å¼•æ“
- **åŠŸèƒ½**: åŸºäºSerpAPIçš„å¤šæœç´¢å¼•æ“æ”¯æŒ
- **ç‰¹æ€§**: æ”¯æŒGoogleã€Bingç­‰å¤šç§æœç´¢å¼•æ“
- **ä½œç”¨**: æä¾›æ ‡å‡†åŒ–çš„åœ¨çº¿æœç´¢æ¥å£

### 3. æ’åºåŠŸèƒ½æ¨¡å— (Ranking)

**rerank_server.py** - é‡æ’åºæœåŠ¡
- **åŠŸèƒ½**: åŸºäºCrossEncoderçš„æ–‡æ¡£é‡æ’åº
- **ç‰¹æ€§**: æ‰¹é‡å¤„ç†ã€å¯é…ç½®topk
- **ä½œç”¨**: å¯¹æ£€ç´¢ç»“æœè¿›è¡Œç²¾ç»†åŒ–æ’åº

**retrieval_rerank_server.py** - æ£€ç´¢æ’åºä¸€ä½“åŒ–
- **åŠŸèƒ½**: æ£€ç´¢+é‡æ’åºçš„å®Œæ•´æµæ°´çº¿
- **ç‰¹æ€§**: ä¸¤é˜¶æ®µå¤„ç†ã€ç»Ÿä¸€APIæ¥å£
- **ä½œç”¨**: æä¾›å®Œæ•´çš„æ£€ç´¢-æ’åºè§£å†³æ–¹æ¡ˆ

### 4. ç´¢å¼•æ„å»ºæ¨¡å— (Indexing)

**index_builder.py** - ç´¢å¼•æ„å»ºå™¨
- **åŠŸèƒ½**: æ„å»ºæ£€ç´¢æ‰€éœ€çš„ç´¢å¼•æ–‡ä»¶
- **æ”¯æŒ**: BM25ç´¢å¼•ã€FAISSå‘é‡ç´¢å¼•
- **ç‰¹æ€§**: GPUåŠ é€Ÿã€æ‰¹å¤„ç†ã€å¤šç§ç´¢å¼•ç±»å‹
- **ä½œç”¨**: å°†åŸå§‹è¯­æ–™è½¬æ¢ä¸ºå¯æ£€ç´¢çš„ç´¢å¼•

### 5. æ‰§è¡Œè„šæœ¬æ¨¡å— (Scripts)

**build_index.sh** - ç´¢å¼•æ„å»ºè„šæœ¬
- **åŠŸèƒ½**: ç´¢å¼•æ„å»ºçš„Shellå°è£…
- **ç”¨é€”**: æ ‡å‡†åŒ–ç´¢å¼•æ„å»ºæµç¨‹
- **ä½œç”¨**: ç®€åŒ–ç´¢å¼•æ„å»ºæ“ä½œ

**retrieval.sh** - æ‰¹é‡æ£€ç´¢è„šæœ¬
- **åŠŸèƒ½**: æ‰¹é‡æ•°æ®é›†æ£€ç´¢å¤„ç†
- **ç”¨é€”**: åœ¨æ•°æ®é›†ä¸Šè¿›è¡Œå¤§è§„æ¨¡æ£€ç´¢è¯„ä¼°
- **ä½œç”¨**: æ”¯æŒæ‰¹é‡æ£€ç´¢ä»»åŠ¡

## åŠŸèƒ½æ¶æ„å›¾

```
search_r1/search/
â”œâ”€â”€ æ£€ç´¢æ¨¡å— (Retrieval)
â”‚   â”œâ”€â”€ retrieval.py (æ ¸å¿ƒç®—æ³•)
â”‚   â”œâ”€â”€ retrieval_server.py (APIæœåŠ¡)
â”‚   â””â”€â”€ retrieval_request.py (å®¢æˆ·ç«¯ç¤ºä¾‹)
â”œâ”€â”€ æœç´¢æ¨¡å— (Search)
â”‚   â”œâ”€â”€ google_search_server.py (Googleæœç´¢)
â”‚   â””â”€â”€ serp_search_server.py (é€šç”¨æœç´¢)
â”œâ”€â”€ æ’åºæ¨¡å— (Ranking)
â”‚   â”œâ”€â”€ rerank_server.py (é‡æ’åºæœåŠ¡)
â”‚   â””â”€â”€ retrieval_rerank_server.py (æ£€ç´¢æ’åºä¸€ä½“åŒ–)
â”œâ”€â”€ ç´¢å¼•æ¨¡å— (Indexing)
â”‚   â””â”€â”€ index_builder.py (ç´¢å¼•æ„å»º)
â””â”€â”€ è„šæœ¬æ¨¡å— (Scripts)
    â”œâ”€â”€ build_index.sh (æ„å»ºè„šæœ¬)
    â””â”€â”€ retrieval.sh (æ£€ç´¢è„šæœ¬)
```

### å…¸å‹å·¥ä½œæµç¨‹

1. **ç´¢å¼•å‡†å¤‡é˜¶æ®µ**: `index_builder.py` + `build_index.sh` â†’ æ„å»ºæ£€ç´¢ç´¢å¼•
2. **åŸºç¡€æ£€ç´¢æµç¨‹**: `retrieval.py` â†’ `retrieval_server.py` â†’ æä¾›æ£€ç´¢æœåŠ¡
3. **å¢å¼ºæ£€ç´¢æµç¨‹**: æ£€ç´¢æœåŠ¡ + `rerank_server.py` â†’ é«˜è´¨é‡æ£€ç´¢ç»“æœ
4. **åœ¨çº¿æœç´¢æµç¨‹**: `google_search_server.py`/`serp_search_server.py` â†’ å®æ—¶ç½‘ç»œæœç´¢
5. **å®Œæ•´æµæ°´çº¿**: `retrieval_rerank_server.py` â†’ ä¸€ç«™å¼æ£€ç´¢æ’åºæœåŠ¡

## æ€»ç»“

**æŒ‰åŠŸèƒ½é‡æ–°åˆ†ç±»åï¼Œsearch_r1/searchæ–‡ä»¶å¤¹åŒ…å«5ä¸ªæ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼š**

- ğŸ” **æ£€ç´¢æ¨¡å—** (3æ–‡ä»¶): æä¾›æœ¬åœ°æ–‡æ¡£æ£€ç´¢èƒ½åŠ›
- ğŸŒ **æœç´¢æ¨¡å—** (2æ–‡ä»¶): æä¾›åœ¨çº¿ç½‘ç»œæœç´¢èƒ½åŠ›
- ğŸ“Š **æ’åºæ¨¡å—** (2æ–‡ä»¶): æä¾›ç»“æœé‡æ’åºèƒ½åŠ›
- ğŸ—‚ï¸ **ç´¢å¼•æ¨¡å—** (1æ–‡ä»¶): æä¾›ç´¢å¼•æ„å»ºèƒ½åŠ›
- âš™ï¸ **è„šæœ¬æ¨¡å—** (2æ–‡ä»¶): æä¾›è‡ªåŠ¨åŒ–æ‰§è¡Œèƒ½åŠ›

è¿™ç§åˆ†ç±»æ–¹æ³•æ›´æ¸…æ™°åœ°åæ˜ äº†å„ä¸ªæ–‡ä»¶åœ¨ç³»ç»Ÿä¸­çš„å®é™…åŠŸèƒ½å’ŒèŒè´£åˆ†å·¥ã€‚

---

### é—®é¢˜ 3
ç”¨æˆ·ï¼šè¯·è¯¦ç»†è§£é‡Šç´¢å¼•å‡†å¤‡é˜¶æ®µã€‚index_builder.py + build_index.shçš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿä½¿ç”¨äº†ä»€ä¹ˆåµŒå…¥æ¨¡å‹ï¼Ÿç´¢å¼•æ„å»ºå’Œå…¶ä»–çš„æ¨¡å—æ˜¯å¦‚ä½•é…åˆå·¥ä½œçš„ï¼Ÿ
åŠ©æ‰‹ï¼šæˆ‘æ¥è¯¦ç»†è§£é‡Šç´¢å¼•å‡†å¤‡é˜¶æ®µçš„å·¥ä½œåŸç†å’Œä½œç”¨ã€‚

## ç´¢å¼•å‡†å¤‡é˜¶æ®µè¯¦ç»†è§£æ

### ä¸€ã€æ ¸å¿ƒç›®çš„ä¸ä½œç”¨

ç´¢å¼•å‡†å¤‡é˜¶æ®µçš„ä¸»è¦ç›®çš„æ˜¯**å°†åŸå§‹æ–‡æ¡£æ•°æ®è½¬æ¢ä¸ºé«˜æ•ˆçš„æ£€ç´¢æ•°æ®ç»“æ„**ï¼Œä½¿å¾—åç»­çš„æ£€ç´¢æ“ä½œèƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ç›¸å…³æ–‡æ¡£ã€‚è¿™ä¸€é˜¶æ®µæ˜¯æ•´ä¸ªæ£€ç´¢ç³»ç»Ÿçš„åŸºç¡€è®¾æ–½å»ºè®¾ã€‚

### äºŒã€index_builder.py æ ¸å¿ƒåŠŸèƒ½åˆ†æ

#### 1. **ç´¢å¼•ç±»å‹æ”¯æŒ**
- **BM25ç´¢å¼•**: åŸºäºPyseriniåº“æ„å»ºä¼ ç»Ÿçš„ç¨€ç–æ£€ç´¢ç´¢å¼•
- **å¯†é›†å‘é‡ç´¢å¼•**: åŸºäºFAISSæ„å»ºç°ä»£çš„å‘é‡æ£€ç´¢ç´¢å¼•

#### 2. **æ”¯æŒçš„åµŒå…¥æ¨¡å‹**
```python
MODEL2POOLING = {
    "e5": "mean",        # E5æ¨¡å‹ä½¿ç”¨å¹³å‡æ± åŒ–
    "bge": "cls",        # BGEæ¨¡å‹ä½¿ç”¨CLSæ ‡è®°æ± åŒ–
    "contriever": "mean", # Contrieveræ¨¡å‹ä½¿ç”¨å¹³å‡æ± åŒ–
    'jina': 'mean'       # Jinaæ¨¡å‹ä½¿ç”¨å¹³å‡æ± åŒ–
}
```

**ä¸»è¦æ¨¡å‹ç‰¹æ€§**:
- **E5ç³»åˆ—**: éœ€è¦åœ¨æŸ¥è¯¢å‰åŠ "query:"å‰ç¼€ï¼Œæ–‡æ¡£å‰åŠ "passage:"å‰ç¼€
- **BGEç³»åˆ—**: æŸ¥è¯¢æ—¶éœ€è¦æ·»åŠ ç‰¹æ®Šæç¤ºè¯"Represent this sentence for searching relevant passages:"
- **é€šç”¨å¤„ç†**: é™¤DPRæ¨¡å‹å¤–ï¼Œæ‰€æœ‰å‘é‡éƒ½ä¼šè¿›è¡ŒL2å½’ä¸€åŒ–

#### 3. **å¯†é›†ç´¢å¼•æ„å»ºæµç¨‹**

**æ­¥éª¤åˆ†è§£**:
1. **æ¨¡å‹åŠ è½½**: åŠ è½½æŒ‡å®šçš„åµŒå…¥æ¨¡å‹å’Œåˆ†è¯å™¨
2. **æ‰¹é‡ç¼–ç **: å°†è¯­æ–™æŒ‰æ‰¹æ¬¡è¿›è¡Œç¼–ç ï¼Œæ”¯æŒå¤šGPUå¹¶è¡Œ
3. **å‘é‡å­˜å‚¨**: å¯é€‰æ‹©ä¿å­˜åµŒå…¥å‘é‡åˆ°å†…å­˜æ˜ å°„æ–‡ä»¶
4. **ç´¢å¼•æ„å»º**: ä½¿ç”¨FAISSæ„å»ºé«˜æ•ˆçš„å‘é‡ç´¢å¼•
5. **GPUä¼˜åŒ–**: æ”¯æŒGPUåŠ é€Ÿçš„ç´¢å¼•æ„å»ºå’ŒæŸ¥è¯¢

#### 4. **BM25ç´¢å¼•æ„å»ºæµç¨‹**
1. **æ•°æ®å‡†å¤‡**: å°†JSONLæ ¼å¼çš„è¯­æ–™å¤åˆ¶åˆ°ä¸´æ—¶ç›®å½•
2. **Pyseriniè°ƒç”¨**: ä½¿ç”¨Pyseriniçš„Luceneç´¢å¼•æ„å»ºå™¨
3. **ç´¢å¼•ç”Ÿæˆ**: åˆ›å»ºå€’æ’ç´¢å¼•å’Œè¯é¢‘ç»Ÿè®¡
4. **æ¸…ç†**: åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼Œä¿ç•™ç´¢å¼•ç›®å½•

### ä¸‰ã€build_index.sh è„šæœ¬ä½œç”¨

```bash
# æ ¸å¿ƒé…ç½®å‚æ•°
corpus_file=/your/corpus/jsonl/file     # åŸå§‹è¯­æ–™è·¯å¾„
save_dir=/the/path/to/save/index        # ç´¢å¼•ä¿å­˜è·¯å¾„
retriever_name=e5                       # æ£€ç´¢æ¨¡å‹åç§°
retriever_model=intfloat/e5-base-v2     # å…·ä½“æ¨¡å‹è·¯å¾„

# å…³é”®æ‰§è¡Œå‚æ•°
--use_fp16                              # ä½¿ç”¨åŠç²¾åº¦æµ®ç‚¹
--max_length 256                        # æœ€å¤§åºåˆ—é•¿åº¦
--batch_size 512                        # æ‰¹å¤„ç†å¤§å°
--pooling_method mean                   # æ± åŒ–æ–¹æ³•
--faiss_type Flat                       # FAISSç´¢å¼•ç±»å‹
--save_embedding                        # ä¿å­˜åµŒå…¥å‘é‡
```

**è„šæœ¬ä½œç”¨**:
1. **æ ‡å‡†åŒ–é…ç½®**: æä¾›ç»Ÿä¸€çš„ç´¢å¼•æ„å»ºå‚æ•°é…ç½®
2. **ç¯å¢ƒè®¾ç½®**: æŒ‡å®šGPUè®¾å¤‡(CUDA_VISIBLE_DEVICES)
3. **å‚æ•°ä¼ é€’**: å°†é…ç½®å‚æ•°ä¼ é€’ç»™index_builder.py
4. **çµæ´»æ€§**: æ”¯æŒé€šè¿‡ä¿®æ”¹å‚æ•°æ¥é€‚åº”ä¸åŒéœ€æ±‚

### å››ã€ä¸å…¶ä»–æ¨¡å—çš„é…åˆæœºåˆ¶

#### 1. **ä¸æ£€ç´¢æ¨¡å—çš„é…åˆ**

**ç´¢å¼•ä½¿ç”¨æµç¨‹**:
```python
# retrieval_server.pyä¸­çš„ç´¢å¼•åŠ è½½
self.index = faiss.read_index(self.index_path)  # åŠ è½½FAISSç´¢å¼•
self.corpus = load_corpus(self.corpus_path)     # åŠ è½½åŸå§‹è¯­æ–™
self.encoder = Encoder(...)                      # åŠ è½½ç›¸åŒçš„ç¼–ç å™¨

# æ£€ç´¢è¿‡ç¨‹
query_emb = self.encoder.encode(query)          # æŸ¥è¯¢ç¼–ç 
scores, idxs = self.index.search(query_emb, k=num)  # å‘é‡ç›¸ä¼¼åº¦æœç´¢
results = load_docs(self.corpus, idxs)          # æ ¹æ®ç´¢å¼•åŠ è½½æ–‡æ¡£
```

#### 2. **ä¸€è‡´æ€§ä¿è¯æœºåˆ¶**
- **æ¨¡å‹ä¸€è‡´æ€§**: ç´¢å¼•æ„å»ºå’Œæ£€ç´¢ä½¿ç”¨ç›¸åŒçš„åµŒå…¥æ¨¡å‹
- **é¢„å¤„ç†ä¸€è‡´æ€§**: æ–‡æœ¬é¢„å¤„ç†æ–¹å¼å®Œå…¨ç›¸åŒ
- **ç¼–ç ä¸€è‡´æ€§**: æ± åŒ–æ–¹æ³•ã€å½’ä¸€åŒ–ç­‰å‚æ•°ä¿æŒä¸€è‡´

#### 3. **æ–‡ä»¶é…åˆå…³ç³»**
```
ç´¢å¼•æ–‡ä»¶ç»“æ„:
save_dir/
â”œâ”€â”€ e5_Flat.index              # FAISSç´¢å¼•æ–‡ä»¶ (æ£€ç´¢æ¨¡å—ä½¿ç”¨)
â”œâ”€â”€ emb_e5.memmap              # åµŒå…¥å‘é‡æ–‡ä»¶ (å¯é€‰ï¼Œç”¨äºé‡è½½)
â””â”€â”€ bm25/                      # BM25ç´¢å¼•ç›®å½•
    â”œâ”€â”€ ...                     # Luceneç´¢å¼•æ–‡ä»¶
```

### äº”ã€å®Œæ•´çš„ç´¢å¼•å‡†å¤‡æµç¨‹

#### **é˜¶æ®µ1: æ•°æ®å‡†å¤‡**
1. æ”¶é›†å’Œæ¸…ç†åŸå§‹è¯­æ–™
2. è½¬æ¢ä¸ºæ ‡å‡†JSONLæ ¼å¼
3. ç¡®ä¿è¯­æ–™è´¨é‡(å»é‡ã€è¿‡æ»¤ç­‰)

#### **é˜¶æ®µ2: æ¨¡å‹é…ç½®**
1. é€‰æ‹©åˆé€‚çš„åµŒå…¥æ¨¡å‹(E5/BGEç­‰)
2. é…ç½®æ¨¡å‹å‚æ•°(æ± åŒ–æ–¹æ³•ã€åºåˆ—é•¿åº¦ç­‰)
3. ç¡®å®šç´¢å¼•ç±»å‹(Flat/HNSW/IVFç­‰)

#### **é˜¶æ®µ3: ç´¢å¼•æ„å»º**
1. æ‰§è¡Œbuild_index.shè„šæœ¬
2. æ‰¹é‡ç¼–ç æ–‡æ¡£ä¸ºå‘é‡
3. æ„å»ºFAISSç´¢å¼•æˆ–BM25ç´¢å¼•
4. ä¿å­˜ç´¢å¼•æ–‡ä»¶å’Œå¯é€‰çš„åµŒå…¥å‘é‡

#### **é˜¶æ®µ4: é›†æˆéªŒè¯**
1. æ£€ç´¢æœåŠ¡å™¨åŠ è½½ç´¢å¼•
2. æµ‹è¯•æ£€ç´¢æ€§èƒ½å’Œå‡†ç¡®æ€§
3. è°ƒä¼˜å‚æ•°é…ç½®

### å…­ã€å®é™…åº”ç”¨åœºæ™¯

**å…¸å‹ä½¿ç”¨æ¡ˆä¾‹**:
- **å¤§è§„æ¨¡çŸ¥è¯†åº“æ£€ç´¢**: å°†ç»´åŸºç™¾ç§‘ç­‰å¤§å‹è¯­æ–™æ„å»ºä¸ºå¯æ£€ç´¢ç´¢å¼•
- **æ–‡æ¡£ç›¸ä¼¼åº¦æœç´¢**: æ”¯æŒè¯­ä¹‰ç›¸ä¼¼çš„æ–‡æ¡£æŸ¥æ‰¾
- **é—®ç­”ç³»ç»Ÿ**: ä¸ºé—®é¢˜ç­”æ¡ˆå¯¹æä¾›å¿«é€Ÿçš„å€™é€‰ç­”æ¡ˆæ£€ç´¢

è¿™ä¸ªç´¢å¼•å‡†å¤‡é˜¶æ®µæ˜¯æ•´ä¸ªSearch-R1ç³»ç»Ÿçš„åŸºç¡€è®¾æ–½ï¼Œä¸ºåç»­çš„æ¨ç†-æœç´¢äº¤é”™è®­ç»ƒæä¾›äº†é«˜æ•ˆçš„çŸ¥è¯†æ£€ç´¢èƒ½åŠ›ã€‚

---

### é—®é¢˜ 4
ç”¨æˆ·ï¼šé‡æ’é˜¶æ®µä½¿ç”¨çš„æ¨¡å‹å’Œç´¢å¼•é˜¶æ®µä½¿ç”¨çš„æ¨¡å‹æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿè¯·ç»“åˆå…·ä½“çš„ç¤ºä¾‹è¿›è¡Œè®²è§£
åŠ©æ‰‹ï¼šæˆ‘æ¥è¯¦ç»†è§£é‡Šé‡æ’é˜¶æ®µå’Œç´¢å¼•é˜¶æ®µä½¿ç”¨çš„æ¨¡å‹åŒºåˆ«ï¼Œå¹¶ç»“åˆå…·ä½“ç¤ºä¾‹è¿›è¡Œè®²è§£ã€‚

## é‡æ’é˜¶æ®µä¸ç´¢å¼•é˜¶æ®µæ¨¡å‹çš„è¯¦ç»†å¯¹æ¯”

### ä¸€ã€ç´¢å¼•é˜¶æ®µä½¿ç”¨çš„æ¨¡å‹ï¼ˆåŒç¼–ç å™¨æ¨¡å‹ - Bi-Encoderï¼‰

#### **1. æ¨¡å‹ç±»å‹å’Œæ¶æ„**
- **å…¸å‹æ¨¡å‹**: `intfloat/e5-base-v2` (é»˜è®¤é…ç½®)
- **æ¨¡å‹æ¶æ„**: åŸºäºBERTçš„åŒç¼–ç å™¨æ¶æ„
- **ç¼–ç æ–¹å¼**: ç‹¬ç«‹ç¼–ç æŸ¥è¯¢å’Œæ–‡æ¡£

#### **2. å·¥ä½œåŸç†**
```python
# ç´¢å¼•é˜¶æ®µçš„ç¼–ç è¿‡ç¨‹
# æŸ¥è¯¢ç¼–ç 
if "e5" in self.model_name.lower():
    query_list = [f"query: {query}" for query in query_list]  # æ·»åŠ æŸ¥è¯¢å‰ç¼€
query_embedding = self.encoder.encode(query_list)

# æ–‡æ¡£ç¼–ç  (åœ¨ç´¢å¼•æ„å»ºæ—¶å®Œæˆ)
if self.retrieval_method == "e5":
    batch_data = [f"passage: {doc}" for doc in batch_data]  # æ·»åŠ æ–‡æ¡£å‰ç¼€
doc_embedding = self.encoder.encode(batch_data)

# ç›¸ä¼¼åº¦è®¡ç®—ï¼šé€šè¿‡å‘é‡ç‚¹ç§¯è®¡ç®—
scores, idxs = self.index.search(query_emb, k=num)
```

#### **3. æ ¸å¿ƒç‰¹ç‚¹**
- **å•å‘ç¼–ç **: æŸ¥è¯¢å’Œæ–‡æ¡£åˆ†åˆ«ç‹¬ç«‹ç¼–ç 
- **é¢„è®¡ç®—**: æ–‡æ¡£å‘é‡å¯ä»¥é¢„å…ˆè®¡ç®—å¹¶å­˜å‚¨ä¸ºç´¢å¼•
- **å¿«é€Ÿæ£€ç´¢**: é€šè¿‡å‘é‡ç›¸ä¼¼åº¦å¿«é€Ÿæ‰¾åˆ°å€™é€‰æ–‡æ¡£
- **å¯æ‰©å±•æ€§**: æ”¯æŒå¤§è§„æ¨¡æ–‡æ¡£åº“çš„å¿«é€Ÿæ£€ç´¢

### äºŒã€é‡æ’é˜¶æ®µä½¿ç”¨çš„æ¨¡å‹ï¼ˆäº¤å‰ç¼–ç å™¨æ¨¡å‹ - Cross-Encoderï¼‰

#### **1. æ¨¡å‹ç±»å‹å’Œæ¶æ„**
- **å…¸å‹æ¨¡å‹**: `cross-encoder/ms-marco-MiniLM-L12-v2` (é»˜è®¤é…ç½®)
- **æ¨¡å‹æ¶æ„**: åŸºäºBERTçš„äº¤å‰ç¼–ç å™¨æ¶æ„
- **ç¼–ç æ–¹å¼**: è”åˆç¼–ç æŸ¥è¯¢-æ–‡æ¡£å¯¹

#### **2. å·¥ä½œåŸç†**
```python
# é‡æ’é˜¶æ®µçš„ç¼–ç è¿‡ç¨‹
# æ„å»ºæŸ¥è¯¢-æ–‡æ¡£å¯¹
pairs = []
for qid, query in enumerate(queries):
    for document in documents:
        for doc_item in document:
            doc = self._passage_to_string(doc_item)  # æ ¼å¼åŒ–æ–‡æ¡£
            pairs.append((query, doc))  # ç»„åˆæˆæŸ¥è¯¢-æ–‡æ¡£å¯¹

# è”åˆç¼–ç å’Œè¯„åˆ†
scores = self.model.predict(pairs, batch_size=self.batch_size)
# ç›´æ¥è¾“å‡ºç›¸å…³æ€§å¾—åˆ†ï¼Œæ— éœ€é¢å¤–çš„ç›¸ä¼¼åº¦è®¡ç®—
```

#### **3. æ ¸å¿ƒç‰¹ç‚¹**
- **åŒå‘ç¼–ç **: æŸ¥è¯¢å’Œæ–‡æ¡£ä¸€èµ·è¾“å…¥æ¨¡å‹
- **äº¤äº’å¼æ³¨æ„åŠ›**: æ¨¡å‹èƒ½å¤Ÿå­¦ä¹ æŸ¥è¯¢å’Œæ–‡æ¡£ä¹‹é—´çš„ç»†ç²’åº¦äº¤äº’
- **é«˜è´¨é‡æ’åº**: æä¾›æ›´ç²¾ç¡®çš„ç›¸å…³æ€§åˆ¤æ–­
- **è®¡ç®—å¯†é›†**: éœ€è¦å¯¹æ¯ä¸ªæŸ¥è¯¢-æ–‡æ¡£å¯¹è¿›è¡Œå•ç‹¬è®¡ç®—

### ä¸‰ã€ä¸¤ç§æ¨¡å‹çš„æ¶æ„å·®å¼‚å¯¹æ¯”

| ç‰¹å¾ç»´åº¦ | åŒç¼–ç å™¨æ¨¡å‹ (Bi-Encoder) | äº¤å‰ç¼–ç å™¨æ¨¡å‹ (Cross-Encoder) |
|---------|---------------------------|--------------------------------|
| **å…¸å‹æ¨¡å‹** | `intfloat/e5-base-v2` | `cross-encoder/ms-marco-MiniLM-L12-v2` |
| **ç¼–ç æ–¹å¼** | æŸ¥è¯¢å’Œæ–‡æ¡£ç‹¬ç«‹ç¼–ç  | æŸ¥è¯¢-æ–‡æ¡£å¯¹è”åˆç¼–ç  |
| **è¾“å…¥æ ¼å¼** | å•ä¸ªæ–‡æœ¬åºåˆ— | `[CLS] query [SEP] document [SEP]` |
| **æ³¨æ„åŠ›æœºåˆ¶** | æ–‡æœ¬å†…éƒ¨è‡ªæ³¨æ„åŠ› | è·¨æ–‡æœ¬äº¤äº’æ³¨æ„åŠ› |
| **é¢„è®¡ç®—æ”¯æŒ** | âœ… æ–‡æ¡£å‘é‡å¯é¢„è®¡ç®— | âŒ éœ€è¦å®æ—¶è®¡ç®— |
| **æ£€ç´¢é€Ÿåº¦** | âš¡ æå¿« (æ¯«ç§’çº§) | ğŸŒ è¾ƒæ…¢ (ç§’çº§) |
| **æ’åºè´¨é‡** | ğŸ“Š ä¸­ç­‰ (å¬å›å¯¼å‘) | ğŸ¯ é«˜ç²¾åº¦ (ç²¾ç¡®å¯¼å‘) |
| **å†…å­˜éœ€æ±‚** | ğŸ’¾ é«˜ (å­˜å‚¨æ–‡æ¡£å‘é‡) | ğŸ”§ ä½ (æ— éœ€å­˜å‚¨å‘é‡) |
| **æ‰©å±•æ€§** | ğŸ“ˆ æ”¯æŒç™¾ä¸‡çº§æ–‡æ¡£ | ğŸ“‰ é€‚åˆç™¾çº§æ–‡æ¡£ |

### å››ã€å…·ä½“ç¤ºä¾‹è¯´æ˜ä¸¤ä¸ªé˜¶æ®µçš„é…åˆ

#### **ç¤ºä¾‹åœºæ™¯**: ç”¨æˆ·æŸ¥è¯¢"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"

**é˜¶æ®µ1: ç´¢å¼•/æ£€ç´¢é˜¶æ®µ (Bi-Encoder)**

```python
# 1. æŸ¥è¯¢ç¼–ç  (ä½¿ç”¨E5æ¨¡å‹)
query = "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"
formatted_query = "query: ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"
query_vector = e5_model.encode(formatted_query)  # è¾“å‡º: 768ç»´å‘é‡

# 2. å‘é‡ç›¸ä¼¼åº¦æœç´¢ (é¢„è®¡ç®—çš„æ–‡æ¡£ç´¢å¼•)
doc_vectors = load_faiss_index("e5_Flat.index")  # ç™¾ä¸‡çº§æ–‡æ¡£å‘é‡
scores, doc_ids = faiss_search(query_vector, doc_vectors, topk=50)

# 3. åˆæ­¥æ£€ç´¢ç»“æœ
retrieved_docs = [
    {"id": 1, "content": "\"æœºå™¨å­¦ä¹ åŸºç¡€\"\næœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯..."},
    {"id": 5, "content": "\"æ·±åº¦å­¦ä¹ æ¦‚è¿°\"\næ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„å­é¢†åŸŸ..."},
    {"id": 23, "content": "\"ç»Ÿè®¡å­¦æ–¹æ³•\"\nç»Ÿè®¡å­¦æä¾›äº†æœºå™¨å­¦ä¹ çš„åŸºç¡€ç†è®º..."},
    # ... å…±50ä¸ªå€™é€‰æ–‡æ¡£
]
```

**é˜¶æ®µ2: é‡æ’é˜¶æ®µ (Cross-Encoder)**

```python
# 1. æ„å»ºæŸ¥è¯¢-æ–‡æ¡£å¯¹
query_doc_pairs = [
    ("ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ", "(Title: æœºå™¨å­¦ä¹ åŸºç¡€) æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯..."),
    ("ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ", "(Title: æ·±åº¦å­¦ä¹ æ¦‚è¿°) æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„å­é¢†åŸŸ..."),
    ("ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ", "(Title: ç»Ÿè®¡å­¦æ–¹æ³•) ç»Ÿè®¡å­¦æä¾›äº†æœºå™¨å­¦ä¹ çš„åŸºç¡€ç†è®º..."),
    # ... 50ä¸ªæŸ¥è¯¢-æ–‡æ¡£å¯¹
]

# 2. äº¤å‰ç¼–ç å™¨è¯„åˆ† (ä½¿ç”¨ms-marco-MiniLMæ¨¡å‹)
rerank_scores = cross_encoder.predict(query_doc_pairs)
# è¾“å‡º: [0.95, 0.82, 0.67, ...]  ç›¸å…³æ€§å¾—åˆ†

# 3. é‡æ–°æ’åºå¹¶è¿”å›top-3
final_results = sorted(zip(retrieved_docs, rerank_scores),
                      key=lambda x: x[1], reverse=True)[:3]

# æœ€ç»ˆç»“æœ
final_results = [
    {"doc": {"content": "\"æœºå™¨å­¦ä¹ åŸºç¡€\"\næœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯..."},
     "score": 0.95},
    {"doc": {"content": "\"æ·±åº¦å­¦ä¹ æ¦‚è¿°\"\næ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„å­é¢†åŸŸ..."},
     "score": 0.82},
    {"doc": {"content": "\"ç»Ÿè®¡å­¦æ–¹æ³•\"\nç»Ÿè®¡å­¦æä¾›äº†æœºå™¨å­¦ä¹ çš„åŸºç¡€ç†è®º..."},
     "score": 0.67}
]
```

#### **ä¸¤é˜¶æ®µé…åˆçš„å…³é”®ä¼˜åŠ¿**

1. **æ•ˆç‡ä¸ç²¾åº¦å¹³è¡¡**: ç¬¬ä¸€é˜¶æ®µé€šè¿‡å‘é‡æ£€ç´¢å¿«é€Ÿç­›é€‰å€™é€‰é›†ï¼Œç¡®ä¿é«˜å¬å›ç‡ï¼›ç¬¬äºŒé˜¶æ®µé€šè¿‡äº¤å‰ç¼–ç ç²¾ç»†æ’åºï¼Œç¡®ä¿é«˜ç²¾ç¡®ç‡ï¼Œå®ç°äº†æ•ˆç‡å’Œè´¨é‡çš„æœ€ä½³å¹³è¡¡ã€‚

2. **è®¡ç®—èµ„æºä¼˜åŒ–**: é¿å…äº†å¯¹ç™¾ä¸‡çº§æ–‡æ¡£è¿›è¡Œæ˜‚è´µçš„äº¤å‰ç¼–ç è®¡ç®—ï¼Œå°†å¤æ‚è®¡ç®—é™åˆ¶åœ¨ç™¾çº§å€™é€‰æ–‡æ¡£èŒƒå›´å†…ï¼Œå¤§å¹…é™ä½è®¡ç®—æˆæœ¬ã€‚

3. **æ¨¡å—åŒ–è®¾è®¡**: ä¸¤ä¸ªé˜¶æ®µå¯ä»¥ç‹¬ç«‹ä¼˜åŒ–å’Œæ›¿æ¢ï¼Œå¦‚æ›´æ¢æ›´å¥½çš„åµŒå…¥æ¨¡å‹æˆ–é‡æ’åºæ¨¡å‹ï¼Œæé«˜äº†ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

### äº”ã€å®Œæ•´çš„ä¸¤é˜¶æ®µæ£€ç´¢æµç¨‹ç¤ºä¾‹

```python
# å®Œæ•´çš„æ£€ç´¢-é‡æ’åºæµç¨‹
def two_stage_retrieval(query: str):
    # é˜¶æ®µ1: å¿«é€Ÿæ£€ç´¢ (Bi-Encoder)
    retriever = DenseRetriever(config)
    initial_results = retriever.search(query, num=50)  # æ£€ç´¢50ä¸ªå€™é€‰æ–‡æ¡£

    # é˜¶æ®µ2: ç²¾ç»†é‡æ’ (Cross-Encoder)
    reranker = CrossEncoderReranker(rerank_config)
    final_results = reranker.rerank([query], [initial_results], topk=5)

    return final_results

# å®é™…è°ƒç”¨
results = two_stage_retrieval("ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ")
# è¾“å‡º: ç»è¿‡ä¸¤é˜¶æ®µå¤„ç†çš„é«˜è´¨é‡æ£€ç´¢ç»“æœ
```

### å…­ã€æ€§èƒ½å’Œèµ„æºæ¶ˆè€—å¯¹æ¯”

#### **è®¡ç®—å¤æ‚åº¦åˆ†æ**

**Bi-Encoderé˜¶æ®µ**:
- **ç´¢å¼•æ„å»º**: O(NÃ—L) - Nä¸ºæ–‡æ¡£æ•°ï¼ŒLä¸ºå¹³å‡é•¿åº¦
- **æŸ¥è¯¢å¤„ç†**: O(1) - å¸¸æ•°æ—¶é—´å¤æ‚åº¦
- **å†…å­˜å ç”¨**: O(NÃ—d) - dä¸ºå‘é‡ç»´åº¦(768)
- **å•æ¬¡æŸ¥è¯¢**: ~10-50æ¯«ç§’

**Cross-Encoderé˜¶æ®µ**:
- **é‡æ’åº**: O(kÃ—L) - kä¸ºå€™é€‰æ–‡æ¡£æ•°(é€šå¸¸50-100)
- **å†…å­˜å ç”¨**: O(L) - ä»…éœ€å­˜å‚¨è¾“å…¥åºåˆ—
- **é‡æ’åºæ—¶é—´**: ~1-5ç§’(å–å†³äºkå€¼)

### ä¸ƒã€æ€»ç»“ï¼šä¸¤ç§æ¨¡å‹çš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯

#### **åŒç¼–ç å™¨æ¨¡å‹ (Bi-Encoder)**

**ä¼˜ç‚¹**:
- âš¡ **æ£€ç´¢é€Ÿåº¦å¿«**: å‘é‡æ£€ç´¢å¯åœ¨æ¯«ç§’çº§å®Œæˆ
- ğŸ“ˆ **å¯æ‰©å±•æ€§å¼º**: æ”¯æŒç™¾ä¸‡ç”šè‡³åƒä¸‡çº§æ–‡æ¡£åº“
- ğŸ’¾ **æ”¯æŒé¢„è®¡ç®—**: æ–‡æ¡£å‘é‡å¯é¢„å…ˆè®¡ç®—å’Œç¼“å­˜
- ğŸ”§ **éƒ¨ç½²ç®€å•**: ä¸€æ¬¡è®­ç»ƒï¼Œå¤šæ¬¡ä½¿ç”¨

**ç¼ºç‚¹**:
- ğŸ“Š **ç²¾åº¦æœ‰é™**: ç¼ºä¹æŸ¥è¯¢-æ–‡æ¡£äº¤äº’ï¼Œç›¸å…³æ€§åˆ¤æ–­ä¸å¤Ÿç²¾ç»†
- ğŸ”’ **è¯­ä¹‰ç†è§£æµ…**: åªèƒ½æ•è·è¡¨å±‚è¯­ä¹‰ç›¸ä¼¼æ€§
- ğŸ“ **é•¿åº¦é™åˆ¶**: å—é™äºæ¨¡å‹çš„æœ€å¤§åºåˆ—é•¿åº¦

**é€‚ç”¨åœºæ™¯**:
- å¤§è§„æ¨¡æ–‡æ¡£åº“çš„åˆæ­¥ç­›é€‰
- å®æ—¶æ£€ç´¢åº”ç”¨
- å¬å›é˜¶æ®µçš„é«˜æ•ˆå¤„ç†

#### **äº¤å‰ç¼–ç å™¨æ¨¡å‹ (Cross-Encoder)**

**ä¼˜ç‚¹**:
- ğŸ¯ **é«˜ç²¾åº¦æ’åº**: æ·±åº¦ç†è§£æŸ¥è¯¢-æ–‡æ¡£ç›¸å…³æ€§
- ğŸ” **ç»†ç²’åº¦äº¤äº’**: é€šè¿‡æ³¨æ„åŠ›æœºåˆ¶æ•è·å¤æ‚è¯­ä¹‰å…³ç³»
- ğŸ§  **è¯­ä¹‰ç†è§£æ·±**: èƒ½å¤Ÿè¯†åˆ«éšå«çš„è¯­ä¹‰å…³è”
- ğŸ“Š **æ’åºè´¨é‡**: åœ¨ç›¸å…³æ€§åˆ¤æ–­ä»»åŠ¡ä¸Šè¡¨ç°ä¼˜å¼‚

**ç¼ºç‚¹**:
- ğŸŒ **è®¡ç®—é€Ÿåº¦æ…¢**: éœ€è¦å¯¹æ¯ä¸ªå€™é€‰æ–‡æ¡£å•ç‹¬è®¡ç®—
- ğŸ“‰ **æ‰©å±•æ€§å·®**: ä¸é€‚åˆå¤§è§„æ¨¡æ–‡æ¡£åº“
- ğŸ’° **èµ„æºæ¶ˆè€—é«˜**: æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦å¤§é‡è®¡ç®—
- â±ï¸ **å®æ—¶æ€§å·®**: ä¸é€‚åˆéœ€è¦å¿«é€Ÿå“åº”çš„åœºæ™¯

**é€‚ç”¨åœºæ™¯**:
- å°è§„æ¨¡å€™é€‰æ–‡æ¡£çš„ç²¾ç»†æ’åº
- ç¦»çº¿æ–‡æ¡£è¯„ä¼°
- å¯¹ç²¾åº¦è¦æ±‚æé«˜çš„åº”ç”¨

### å…«ã€ä¸¤é˜¶æ®µååŒçš„æ™ºæ…§

1. **åˆ†å·¥æ˜ç¡®**: Bi-Encoderè´Ÿè´£"å¹¿åº¦"ï¼Œå¿«é€Ÿç­›é€‰ç›¸å…³å€™é€‰ï¼›Cross-Encoderè´Ÿè´£"æ·±åº¦"ï¼Œç²¾ç»†æ’åºæœ€ä¼˜ç»“æœï¼Œä½“ç°äº†"å…ˆå¬å›åæ’åº"çš„ç»å…¸ä¿¡æ¯æ£€ç´¢èŒƒå¼ã€‚

2. **æˆæœ¬æ•ˆç›Š**: é€šè¿‡ä¸¤é˜¶æ®µè®¾è®¡ï¼Œåœ¨ä¿è¯æ£€ç´¢è´¨é‡çš„åŒæ—¶å¤§å¹…é™ä½è®¡ç®—æˆæœ¬ï¼Œé¿å…äº†åœ¨å¤§è§„æ¨¡æ•°æ®é›†ä¸Šä½¿ç”¨æ˜‚è´µçš„äº¤å‰ç¼–ç å™¨ã€‚

3. **å®ç”¨æ€§å¼º**: è¿™ç§æ¶æ„åœ¨å·¥ä¸šç•Œå¾—åˆ°å¹¿æ³›åº”ç”¨ï¼Œå¦‚æœç´¢å¼•æ“ã€é—®ç­”ç³»ç»Ÿã€æ¨èç³»ç»Ÿç­‰ï¼Œå¹³è¡¡äº†æ•ˆç‡å’Œè´¨é‡çš„éœ€æ±‚ã€‚

**æœ€ç»ˆå»ºè®®**: åœ¨Search-R1é¡¹ç›®ä¸­ï¼Œè¿™ç§ä¸¤é˜¶æ®µæ£€ç´¢æ¶æ„ä¸ºè¯­è¨€æ¨¡å‹æä¾›äº†é«˜è´¨é‡çš„å¤–éƒ¨çŸ¥è¯†æºï¼Œæ—¢ä¿è¯äº†æ£€ç´¢æ•ˆç‡ï¼Œåˆç¡®ä¿äº†ä¿¡æ¯çš„ç›¸å…³æ€§ï¼Œæ˜¯å®ç°"æ¨ç†ä¸æœç´¢äº¤é”™"è®­ç»ƒæ¨¡å¼çš„å…³é”®æŠ€æœ¯æ”¯æ’‘ã€‚

é€šè¿‡ä»¥ä¸Šè¯¦ç»†åˆ†æï¼Œå¯ä»¥çœ‹å‡ºé‡æ’é˜¶æ®µå’Œç´¢å¼•é˜¶æ®µä½¿ç”¨çš„æ¨¡å‹åœ¨è®¾è®¡ç†å¿µã€æ¶æ„ç‰¹ç‚¹å’Œé€‚ç”¨åœºæ™¯ä¸Šå­˜åœ¨æ ¹æœ¬æ€§å·®å¼‚ã€‚ä¸¤ç§æ¨¡å‹å„å¸å…¶èŒï¼Œé€šè¿‡å·§å¦™çš„åˆ†å·¥åä½œï¼Œå®ç°äº†é«˜æ•ˆè€Œç²¾ç¡®çš„æ–‡æ¡£æ£€ç´¢ç³»ç»Ÿã€‚

---

### é—®é¢˜ 5
ç”¨æˆ·ï¼šsearch_r1/llm_agent/generation.pyæ–‡ä»¶ä¸­æœ€æ ¸å¿ƒçš„å‡½æ•°æ˜¯ä¸æ˜¯run_llm_loopï¼Ÿ
åŠ©æ‰‹ï¼šè®©æˆ‘æŸ¥çœ‹search_r1/llm_agent/generation.pyæ–‡ä»¶æ¥ç¡®è®¤æœ€æ ¸å¿ƒçš„å‡½æ•°ã€‚

é€šè¿‡è¯¦ç»†åˆ†æ`search_r1/llm_agent/generation.py`æ–‡ä»¶ï¼Œæˆ‘å¯ä»¥ç¡®è®¤**`run_llm_loop`ç¡®å®æ˜¯æœ€æ ¸å¿ƒçš„å‡½æ•°**ã€‚è®©æˆ‘è¯¦ç»†è§£é‡ŠåŸå› ï¼š

## run_llm_loopå‡½æ•°çš„æ ¸å¿ƒåœ°ä½

#### **1. åŠŸèƒ½å®šä½ - ä¸»æ§åˆ¶å¾ªç¯**
```python
def run_llm_loop(self, gen_batch, initial_input_ids: torch.Tensor) -> Tuple[Dict, Dict]:
    """Run main LLM generation loop."""
```

**çŠ¶æ€æœºæ§åˆ¶**: run_llm_loopå®ç°äº†å®Œæ•´çš„å¤šè½®æ¨ç†-æœç´¢å¾ªç¯ï¼Œç®¡ç†ç€ä»åˆå§‹è¾“å…¥åˆ°æœ€ç»ˆç­”æ¡ˆçš„æ•´ä¸ªçŠ¶æ€æµè½¬è¿‡ç¨‹ã€‚

**èµ„æºåè°ƒ**: å®ƒåè°ƒäº†LLMç”Ÿæˆã€ç¯å¢ƒæ‰§è¡Œã€æœç´¢è°ƒç”¨ç­‰å¤šä¸ªç»„ä»¶ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„ä¸­å¤®è°ƒåº¦å™¨ã€‚

**æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡å¹¶è¡Œå¤„ç†å¤šä¸ªå¯¹è¯å®ä¾‹ï¼Œå¤§å¹…æå‡äº†ç³»ç»Ÿæ•ˆç‡ã€‚

#### **2. æ ¸å¿ƒé€»è¾‘æµç¨‹**

**é˜¶æ®µ1: åˆå§‹åŒ–** (ç¬¬220-231è¡Œ)
```python
original_left_side = {'input_ids': initial_input_ids[:, -self.config.max_start_length:]}
original_right_side = {'responses': initial_input_ids[:, []], 'responses_with_info_mask': initial_input_ids[:, []]}
active_mask = torch.ones(gen_batch.batch['input_ids'].shape[0], dtype=torch.bool)
```

**é˜¶æ®µ2: å¤šè½®ç”Ÿæˆå¾ªç¯** (ç¬¬234-276è¡Œ)
```python
for step in range(self.config.max_turns):
    # 1. LLMç”Ÿæˆå“åº”
    gen_output = self._generate_with_gpu_padding(rollings_active)

    # 2. åå¤„ç†å“åº”
    responses_ids, responses_str = self._postprocess_responses(gen_output.batch['responses'])

    # 3. æ‰§è¡ŒåŠ¨ä½œ(æœç´¢æˆ–å›ç­”)
    next_obs, dones, valid_action, is_search = self.execute_predictions(...)

    # 4. æ›´æ–°çŠ¶æ€
    rollings = self._update_rolling_state(rollings, responses_ids, next_obs_ids)
```

**é˜¶æ®µ3: æœ€ç»ˆç”Ÿæˆ** (ç¬¬278-310è¡Œ)
```python
if active_mask.sum():
    # æœ€åä¸€æ¬¡ç”Ÿæˆï¼Œç”¨äºæœ€ç»ˆç­”æ¡ˆ
    gen_output = self._generate_with_gpu_padding(rollings_active)
    # ... å¤„ç†æœ€ç»ˆç­”æ¡ˆ
```

### äºŒã€ä¸å…¶ä»–é‡è¦å‡½æ•°çš„å¯¹æ¯”

#### **æ‰§è¡Œå‡½æ•° (execute_predictions) - ç¯å¢ƒäº¤äº’**
- **ä½œç”¨**: æ‰§è¡ŒLLMç”Ÿæˆçš„åŠ¨ä½œï¼Œè°ƒç”¨æœç´¢å¼•æ“
- **åœ°ä½**: è¢«run_llm_loopè°ƒç”¨ï¼Œæ˜¯ç¯å¢ƒäº¤äº’å±‚
- **å¤æ‚åº¦**: ä¸­ç­‰ï¼Œä¸»è¦æ˜¯è¯·æ±‚å¤„ç†å’Œå“åº”æ ¼å¼åŒ–

#### **ç”Ÿæˆå‡½æ•° (_generate_with_gpu_padding) - LLMæ¨ç†**
- **ä½œç”¨**: è°ƒç”¨LLMæ¨¡å‹ç”Ÿæˆæ–‡æœ¬
- **åœ°ä½**: è¢«run_llm_loopè°ƒç”¨ï¼Œæ˜¯æ¨¡å‹æ¨ç†å±‚
- **å¤æ‚åº¦**: ä¸­ç­‰ï¼Œä¸»è¦å¤„ç†å¤šGPUå¹¶è¡Œ

#### **çŠ¶æ€æ›´æ–°å‡½æ•° (_update_rolling_state) - çŠ¶æ€ç®¡ç†**
- **ä½œç”¨**: æ›´æ–°å¯¹è¯çŠ¶æ€å’Œä¸Šä¸‹æ–‡
- **åœ°ä½**: è¢«run_llm_loopè°ƒç”¨ï¼Œæ˜¯çŠ¶æ€ç®¡ç†å±‚
- **å¤æ‚åº¦**: è¾ƒä½ï¼Œä¸»è¦æ˜¯å¼ é‡æ“ä½œ

#### **æœç´¢å‡½æ•° (batch_search) - å¤–éƒ¨æ¥å£**
- **ä½œç”¨**: è°ƒç”¨å¤–éƒ¨æœç´¢API
- **åœ°ä½**: è¢«execute_predictionsè°ƒç”¨ï¼Œæ˜¯å¤–éƒ¨æ¥å£å±‚
- **å¤æ‚åº¦**: è¾ƒä½ï¼Œä¸»è¦æ˜¯HTTPè¯·æ±‚

### ä¸‰ã€ä¸ºä»€ä¹ˆrun_llm_loopæ˜¯æœ€æ ¸å¿ƒçš„ï¼Ÿ

#### **1. æ¶æ„ä¸­å¿ƒåœ°ä½**
```python
# run_llm_loopæ§åˆ¶ç€æ•´ä¸ªæ¨ç†-æœç´¢å¾ªç¯
# å®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªè°ƒç”¨æ‰€æœ‰å…¶ä»–ä¸»è¦å‡½æ•°çš„å‡½æ•°
run_llm_loop()
â”œâ”€â”€ _generate_with_gpu_padding()    # LLMç”Ÿæˆ
â”œâ”€â”€ _postprocess_responses()        # å“åº”å¤„ç†
â”œâ”€â”€ execute_predictions()           # ç¯å¢ƒæ‰§è¡Œ
â”‚   â””â”€â”€ batch_search()              # å¤–éƒ¨æœç´¢
â””â”€â”€ _update_rolling_state()         # çŠ¶æ€æ›´æ–°
```

#### **2. çŠ¶æ€ç®¡ç†æ ¸å¿ƒ**
- **æ´»è·ƒçŠ¶æ€è·Ÿè¸ª**: `active_mask` è·Ÿè¸ªå“ªäº›å¯¹è¯è¿˜åœ¨è¿›è¡Œ
- **è½®æ¬¡ç»Ÿè®¡**: `turns_stats` è®°å½•æ¯ä¸ªå¯¹è¯çš„è½®æ¬¡
- **åŠ¨ä½œç»Ÿè®¡**: `valid_action_stats`, `valid_search_stats` ç»Ÿè®¡æœ‰æ•ˆåŠ¨ä½œ
- **æœ€ç»ˆè¾“å‡ºç»„åˆ**: `_compose_final_output()` ç»„åˆå®Œæ•´çš„å¯¹è¯å†å²

#### **3. ç®—æ³•å¤æ‚åº¦æœ€é«˜**
- **æ—¶é—´å¤æ‚åº¦**: O(TÃ—G) å…¶ä¸­Tæ˜¯æœ€å¤§è½®æ¬¡ï¼ŒGæ˜¯ç”Ÿæˆæˆæœ¬
- **ç©ºé—´å¤æ‚åº¦**: O(BÃ—L) å…¶ä¸­Bæ˜¯æ‰¹æ¬¡å¤§å°ï¼ŒLæ˜¯åºåˆ—é•¿åº¦
- **æ§åˆ¶æµå¤æ‚**: åŒ…å«å¾ªç¯ã€æ¡ä»¶åˆ¤æ–­ã€å¼‚å¸¸å¤„ç†ç­‰å¤æ‚é€»è¾‘

#### **4. ä¸šåŠ¡é€»è¾‘æœ€å®Œæ•´**
- **å¤šè½®å¯¹è¯**: å®ç°å®Œæ•´çš„æ¨ç†-æœç´¢å¾ªç¯
- **é”™è¯¯å¤„ç†**: å¤„ç†æ— æ•ˆåŠ¨ä½œã€æœç´¢å¤±è´¥ç­‰å¼‚å¸¸æƒ…å†µ
- **èµ„æºç®¡ç†**: ä¼˜åŒ–GPUå†…å­˜ä½¿ç”¨å’Œæ‰¹å¤„ç†æ•ˆç‡

### å››ã€run_llm_loopçš„ç²¾å¦™è®¾è®¡

#### **1. åŒé˜¶æ®µè®¾è®¡**
```python
# é˜¶æ®µ1: å¤šè½®æœç´¢-æ¨ç†å¾ªç¯ (ç¬¬234-276è¡Œ)
for step in range(self.config.max_turns):
    # æ”¯æŒæœç´¢åŠ¨ä½œï¼Œè·å–å¤–éƒ¨ä¿¡æ¯

# é˜¶æ®µ2: æœ€ç»ˆç­”æ¡ˆç”Ÿæˆ (ç¬¬278-310è¡Œ)
if active_mask.sum():
    # ä»…æ”¯æŒç­”æ¡ˆåŠ¨ä½œï¼Œç”Ÿæˆæœ€ç»ˆå›å¤
```

è¿™ç§è®¾è®¡ç¡®ä¿äº†æ¨¡å‹å…ˆé€šè¿‡æœç´¢æ”¶é›†è¶³å¤Ÿä¿¡æ¯ï¼Œç„¶åå†ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆã€‚

#### **2. æ™ºèƒ½ç»ˆæ­¢æœºåˆ¶**
```python
# å¤šç§ç»ˆæ­¢æ¡ä»¶
if not active_mask.sum():  # æ‰€æœ‰å¯¹è¯éƒ½å®Œæˆ
    break

# åŠ¨ä½œç»ˆæ­¢
if action == 'answer':
    dones.append(1)  # æ ‡è®°ä¸ºå®Œæˆ
```

#### **3. æ‰¹é‡å¹¶è¡Œä¼˜åŒ–**
```python
# æ‰¹é‡å¤„ç†å¤šä¸ªå¯¹è¯å®ä¾‹
active_mask = torch.ones(batch_size, dtype=torch.bool)
rollings_active = DataProto.from_dict({
    k: v[active_mask] for k, v in rollings.batch.items()
})
```

### äº”ã€LLMGenerationManageræ•´ä½“æ¶æ„æ€»ç»“

**åˆ†å±‚æ¶æ„**: LLMGenerationManageré‡‡ç”¨äº†æ¸…æ™°çš„åˆ†å±‚è®¾è®¡ï¼Œrun_llm_loopä½œä¸ºæ§åˆ¶å±‚ï¼Œåè°ƒç€ç”Ÿæˆå±‚ã€æ‰§è¡Œå±‚ã€çŠ¶æ€å±‚ç­‰å¤šä¸ªå­æ¨¡å—ã€‚

**èŒè´£åˆ†ç¦»**: æ¯ä¸ªå‡½æ•°éƒ½æœ‰æ˜ç¡®çš„å•ä¸€èŒè´£ï¼Œrun_llm_loopè´Ÿè´£æ•´ä½“æ§åˆ¶ï¼Œå…¶ä»–å‡½æ•°è´Ÿè´£å…·ä½“å®ç°ï¼Œä½“ç°äº†è‰¯å¥½çš„è½¯ä»¶å·¥ç¨‹åŸåˆ™ã€‚

**å¯æ‰©å±•æ€§**: é€šè¿‡æ¨¡å—åŒ–è®¾è®¡ï¼Œå¯ä»¥è½»æ¾æ›¿æ¢æˆ–ä¼˜åŒ–ä»»ä½•å•ä¸ªç»„ä»¶è€Œä¸å½±å“æ•´ä½“æ¶æ„ã€‚

```
LLMGenerationManager æ¶æ„å›¾
â”œâ”€â”€ run_llm_loop (æ ¸å¿ƒæ§åˆ¶å±‚)
â”‚   â”œâ”€â”€ åˆå§‹åŒ–é˜¶æ®µ
â”‚   â”œâ”€â”€ å¤šè½®ç”Ÿæˆå¾ªç¯
â”‚   â”‚   â”œâ”€â”€ _generate_with_gpu_padding (ç”Ÿæˆå±‚)
â”‚   â”‚   â”œâ”€â”€ _postprocess_responses (å¤„ç†å±‚)
â”‚   â”‚   â”œâ”€â”€ execute_predictions (æ‰§è¡Œå±‚)
â”‚   â”‚   â”‚   â””â”€â”€ batch_search (å¤–éƒ¨æ¥å£)
â”‚   â”‚   â””â”€â”€ _update_rolling_state (çŠ¶æ€å±‚)
â”‚   â”œâ”€â”€ æœ€ç»ˆç­”æ¡ˆç”Ÿæˆ
â”‚   â””â”€â”€ _compose_final_output (è¾“å‡ºå±‚)
â”œâ”€â”€ TensorHelper (å·¥å…·å±‚)
â””â”€â”€ å„ç§è¾…åŠ©å‡½æ•°
```

### å…­ã€ç»“è®º

**æ˜¯çš„ï¼Œ`run_llm_loop`ç¡®å®æ˜¯`search_r1/llm_agent/generation.py`æ–‡ä»¶ä¸­æœ€æ ¸å¿ƒçš„å‡½æ•°**ï¼Œç†ç”±å¦‚ä¸‹ï¼š

1. **æ¶æ„ä¸­å¿ƒ**: å®ƒæ˜¯æ•´ä¸ªLLMç”Ÿæˆç®¡ç†å™¨çš„æ§åˆ¶ä¸­å¿ƒï¼Œåè°ƒæ‰€æœ‰å…¶ä»–ç»„ä»¶
2. **åŠŸèƒ½å®Œæ•´**: å®ç°äº†å®Œæ•´çš„æ¨ç†-æœç´¢äº¤é”™å¾ªç¯ï¼Œæ˜¯Search-R1é¡¹ç›®çš„æ ¸å¿ƒç®—æ³•
3. **å¤æ‚åº¦æœ€é«˜**: åŒ…å«äº†æœ€å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å’Œæ§åˆ¶æµç¨‹
4. **ä¸å¯æ›¿ä»£**: å…¶ä»–å‡½æ•°éƒ½æ˜¯ä¸ºå®ƒæœåŠ¡çš„è¾…åŠ©å‡½æ•°ï¼Œç¼ºå°‘ä»»ä½•ä¸€ä¸ªéƒ½ä¸ä¼šå½±å“æ•´ä½“æ¶æ„ï¼Œä½†ç¼ºå°‘run_llm_loopæ•´ä¸ªç³»ç»Ÿå°±æ— æ³•å·¥ä½œ

è¿™ä¸ªå‡½æ•°å®Œç¾ä½“ç°äº†Search-R1é¡¹ç›®"æ¨ç†ä¸æœç´¢äº¤é”™"çš„æ ¸å¿ƒç†å¿µï¼Œæ˜¯å®ç°è¯­è¨€æ¨¡å‹ä¸å¤–éƒ¨çŸ¥è¯†æºååŒå·¥ä½œçš„å…³é”®æ¢çº½ã€‚

---

### é—®é¢˜ 6
ç”¨æˆ·ï¼šåœ¨run_llm_loopå‡½æ•°ä¸­æ˜¯å¦‚ä½•æ‰§è¡Œæœç´¢åŠŸèƒ½çš„ï¼Ÿè¯·ç»“åˆä»£ç è¿›è¡Œé€æ­¥è®²è§£ã€‚
åŠ©æ‰‹ï¼šæˆ‘æ¥è¯¦ç»†åˆ†æ`run_llm_loop`å‡½æ•°ä¸­æœç´¢åŠŸèƒ½çš„å®Œæ•´æ‰§è¡Œæµç¨‹ï¼Œç»“åˆä»£ç è¿›è¡Œé€æ­¥è®²è§£ã€‚

## run_llm_loopä¸­æœç´¢åŠŸèƒ½çš„å®Œæ•´æ‰§è¡Œæµç¨‹

### æ­¥éª¤1: LLMç”Ÿæˆå“åº” (ç¬¬246è¡Œ)

```python
# åœ¨run_llm_loopå‡½æ•°ä¸­
gen_output = self._generate_with_gpu_padding(rollings_active)
```

LLMæ¨¡å‹æ ¹æ®å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ç”Ÿæˆå“åº”ï¼Œå¯èƒ½åŒ…å«æœç´¢æŒ‡ä»¤æˆ–ç­”æ¡ˆã€‚

### æ­¥éª¤2: å“åº”åå¤„ç† (ç¬¬249è¡Œ)

```python
responses_ids, responses_str = self._postprocess_responses(gen_output.batch['responses'])
```

**æ™ºèƒ½æˆªæ–­**: _postprocess_responseså‡½æ•°ä¼šæ™ºèƒ½åœ°æˆªæ–­å“åº”ï¼Œç¡®ä¿åªä¿ç•™ç¬¬ä¸€ä¸ªå®Œæ•´çš„åŠ¨ä½œæ ‡ç­¾ï¼ˆ<search>æˆ–<answer>ï¼‰ï¼Œé¿å…å¤šä¸ªåŠ¨ä½œæ··åˆã€‚

**æ ¼å¼æ ‡å‡†åŒ–**: é€šè¿‡æˆªæ–­å’Œè¡¥å……é—­åˆæ ‡ç­¾ï¼Œç¡®ä¿æ‰€æœ‰å“åº”éƒ½ç¬¦åˆæ ‡å‡†çš„åŠ¨ä½œæ ¼å¼ï¼Œä¾¿äºåç»­è§£æã€‚

**åŠ¨ä½œéš”ç¦»**: å°†å¤æ‚çš„å“åº”ç®€åŒ–ä¸ºå•ä¸€åŠ¨ä½œï¼Œé™ä½äº†åç»­å¤„ç†çš„å¤æ‚åº¦ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯é æ€§ã€‚

**`_postprocess_responses`å‡½æ•°çš„å·¥ä½œåŸç†**:
```python
# ç¤ºä¾‹è¾“å…¥: "æˆ‘éœ€è¦æœç´¢å…³äºæœºå™¨å­¦ä¹ çš„ä¿¡æ¯<search>æœºå™¨å­¦ä¹ æ˜¯ä»€ä¹ˆ</search>è¿˜æœ‰ä¸€äº›å…¶ä»–å†…å®¹..."
# å¤„ç†å: "æˆ‘éœ€è¦æœç´¢å…³äºæœºå™¨å­¦ä¹ çš„ä¿¡æ¯<search>æœºå™¨å­¦ä¹ æ˜¯ä»€ä¹ˆ</search>"

responses_str = [resp.split('</search>')[0] + '</search>'
                 if '</search>' in resp
                 else resp.split('</answer>')[0] + '</answer>'
                 if '</answer>' in resp
                 else resp
                 for resp in responses_str]
```

### æ­¥éª¤3: æ‰§è¡Œé¢„æµ‹ (ç¬¬253-255è¡Œ)

```python
# å…³é”®ï¼šæ‰§è¡ŒLLMç”Ÿæˆçš„åŠ¨ä½œ
next_obs, dones, valid_action, is_search = self.execute_predictions(
    responses_str, self.tokenizer.pad_token, active_mask
)
```

è¿™æ˜¯æœç´¢åŠŸèƒ½çš„æ ¸å¿ƒå…¥å£ç‚¹ï¼Œè°ƒç”¨äº†`execute_predictions`å‡½æ•°ã€‚

### æ­¥éª¤4: è§£æåŠ¨ä½œç±»å‹ (execute_predictionså‡½æ•°ç¬¬367è¡Œ)

```python
def execute_predictions(self, predictions: List[str], pad_token: str, active_mask=None, do_search=True):
    cur_actions, contents = self.postprocess_predictions(predictions)
```

**`postprocess_predictions`å‡½æ•°è§£æåŠ¨ä½œ**:
```python
# ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æåŠ¨ä½œæ ‡ç­¾å’Œå†…å®¹
pattern = r'<(search|answer)>(.*?)</\1>'
match = re.search(pattern, prediction, re.DOTALL)
if match:
    content = match.group(2).strip()  # æå–æ ‡ç­¾å†…çš„å†…å®¹
    action = match.group(1)           # æå–åŠ¨ä½œç±»å‹(search/answer)
```

**è§£æç¤ºä¾‹**:
- è¾“å…¥: `"<search>ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ </search>"`
- è¾“å‡º: `action='search'`, `content='ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ '`

### æ­¥éª¤5: æ‰¹é‡æœç´¢æŸ¥è¯¢æ”¶é›† (ç¬¬370-375è¡Œ)

```python
# æ”¶é›†æ‰€æœ‰æœç´¢æŸ¥è¯¢
search_queries = [content for action, content in zip(cur_actions, contents) if action == 'search']

# æ‰¹é‡æ‰§è¡Œæœç´¢
if do_search:
    search_results = self.batch_search(search_queries)
    assert len(search_results) == sum([1 for action in cur_actions if action == 'search'])
else:
    search_results = [''] * sum([1 for action in cur_actions if action == 'search'])
```

è¿™é‡Œä½“ç°äº†**æ‰¹é‡ä¼˜åŒ–**çš„è®¾è®¡æ€æƒ³ï¼Œå°†å¤šä¸ªæœç´¢è¯·æ±‚åˆå¹¶å¤„ç†ï¼Œæé«˜æ•ˆç‡ã€‚

### æ­¥éª¤6: æ‰¹é‡æœç´¢æ‰§è¡Œ (batch_searchå‡½æ•°ç¬¬446-458è¡Œ)

```python
def batch_search(self, queries: List[str] = None) -> str:
    results = self._batch_search(queries)['result']
    return [self._passages2string(result) for result in results]

def _batch_search(self, queries):
    payload = {
        "queries": queries,
        "topk": self.config.topk,        # é»˜è®¤è¿”å›å‰3ä¸ªæœ€ç›¸å…³æ–‡æ¡£
        "return_scores": True
    }
    # å‘é€HTTPè¯·æ±‚åˆ°æ£€ç´¢æœåŠ¡å™¨
    return requests.post(self.config.search_url, json=payload).json()
```

**æœåŠ¡è§£è€¦**: é€šè¿‡HTTP APIè°ƒç”¨æ£€ç´¢æœåŠ¡ï¼Œå®ç°äº†LLMç”Ÿæˆæ¨¡å—ä¸æ£€ç´¢æ¨¡å—çš„è§£è€¦ï¼Œä¾¿äºç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•ã€‚

**æ‰¹é‡ä¼˜åŒ–**: å•æ¬¡HTTPè¯·æ±‚å¤„ç†å¤šä¸ªæŸ¥è¯¢ï¼Œå‡å°‘äº†ç½‘ç»œå¼€é”€ï¼Œæé«˜äº†æ•´ä½“æ€§èƒ½ã€‚

**é…ç½®çµæ´»**: é€šè¿‡topkå‚æ•°å¯é…ç½®è¿”å›æ–‡æ¡£æ•°é‡ï¼Œå¹³è¡¡äº†ä¿¡æ¯é‡å’Œä¸Šä¸‹æ–‡é•¿åº¦ã€‚

### æ­¥éª¤7: æœç´¢ç»“æœæ ¼å¼åŒ– (_passages2stringå‡½æ•°ç¬¬460-469è¡Œ)

```python
def _passages2string(self, retrieval_result):
    format_reference = ''
    for idx, doc_item in enumerate(retrieval_result):
        content = doc_item['document']['contents']
        title = content.split("\n")[0]          # æå–æ ‡é¢˜
        text = "\n".join(content.split("\n")[1:])  # æå–æ­£æ–‡
        format_reference += f"Doc {idx+1}(Title: {title}) {text}\n"
    return format_reference
```

**æ ¼å¼åŒ–ç¤ºä¾‹**:
```json
è¾“å…¥: [{"document": {"contents": "\"æœºå™¨å­¦ä¹ åŸºç¡€\"\næœºå™¨å­¦ä¹ æ˜¯AIçš„ä¸€ä¸ªåˆ†æ”¯..."}}]
è¾“å‡º: "Doc 1(Title: æœºå™¨å­¦ä¹ åŸºç¡€) æœºå™¨å­¦ä¹ æ˜¯AIçš„ä¸€ä¸ªåˆ†æ”¯...\n"
```

### æ­¥éª¤8: æœç´¢ç»“æœèå…¥å¯¹è¯ä¸Šä¸‹æ–‡ (ç¬¬390-394è¡Œ)

```python
elif action == 'search':
    # å…³é”®ï¼šå°†æœç´¢ç»“æœåŒ…è£…åœ¨<information>æ ‡ç­¾ä¸­
    next_obs.append(f'\n\n<information>{search_results.pop(0).strip()}</information>\n\n')
    dones.append(0)        # å¯¹è¯ç»§ç»­ï¼Œä¸ç»“æŸ
    valid_action.append(1) # æ ‡è®°ä¸ºæœ‰æ•ˆåŠ¨ä½œ
    is_search.append(1)    # æ ‡è®°ä¸ºæœç´¢åŠ¨ä½œ
```

**æœç´¢ç»“æœèå…¥æœºåˆ¶**:
- **æ ¼å¼æ ‡å‡†åŒ–**: ä½¿ç”¨`<information>`æ ‡ç­¾åŒ…è£…æœç´¢ç»“æœ
- **ä¸Šä¸‹æ–‡åˆ†éš”**: é€šè¿‡æ¢è¡Œç¬¦ä¸å¯¹è¯å†…å®¹åˆ†ç¦»
- **çŠ¶æ€æ›´æ–°**: å°†å¯¹è¯æ ‡è®°ä¸ºç»§ç»­çŠ¶æ€(dones=0)

### æ­¥éª¤9: ä¸Šä¸‹æ–‡çŠ¶æ€æ›´æ–° (ç¬¬264-276è¡Œ)

```python
# å¤„ç†è§‚å¯Ÿç»“æœ
next_obs_ids = self._process_next_obs(next_obs)

# æ›´æ–°å¯¹è¯çŠ¶æ€
rollings = self._update_rolling_state(
    rollings,           # å½“å‰å¯¹è¯å†å²
    responses_ids,      # LLMç”Ÿæˆçš„åŠ¨ä½œ
    next_obs_ids        # æœç´¢ç»“æœè§‚å¯Ÿ
)
```

**`_process_next_obs`å‡½æ•°å¤„ç†**:
```python
def _process_next_obs(self, next_obs: List[str]) -> torch.Tensor:
    next_obs_ids = self.tokenizer(
        next_obs,
        padding='longest',
        return_tensors='pt',
        add_special_tokens=False,
    )['input_ids']

    # æ£€æŸ¥é•¿åº¦é™åˆ¶
    if next_obs_ids.shape[1] > self.config.max_obs_length:
        next_obs_ids = next_obs_ids[:, :self.config.max_obs_length]

    return next_obs_ids
```

### æ­¥éª¤10: ä¸‹ä¸€è½®ç”Ÿæˆå‡†å¤‡

æ›´æ–°åçš„`rollings`åŒ…å«äº†å®Œæ•´çš„å¯¹è¯å†å²ï¼š
```
[ç”¨æˆ·é—®é¢˜] -> [LLMæœç´¢åŠ¨ä½œ] -> [æœç´¢ç»“æœ] -> [ä¸‹ä¸€è½®LLMç”Ÿæˆ]
```

è¿™ä¸ºä¸‹ä¸€è½®çš„LLMç”Ÿæˆæä¾›äº†ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

## å®Œæ•´çš„æœç´¢æ‰§è¡Œæµç¨‹ç¤ºä¾‹

### ç¤ºä¾‹åœºæ™¯ï¼šç”¨æˆ·è¯¢é—®"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"

**è½®æ¬¡1: LLMç”Ÿæˆ**
```
è¾“å…¥: "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"
LLMç”Ÿæˆ: "æˆ‘éœ€è¦æœç´¢ç›¸å…³ä¿¡æ¯<search>æœºå™¨å­¦ä¹ å®šä¹‰å’Œåº”ç”¨</search>"
```

**è½®æ¬¡1: æœç´¢æ‰§è¡Œ**
```python
# 1. è§£æåŠ¨ä½œ
action = 'search'
content = 'æœºå™¨å­¦ä¹ å®šä¹‰å’Œåº”ç”¨'

# 2. æ‰¹é‡æœç´¢è¯·æ±‚
payload = {
    "queries": ["æœºå™¨å­¦ä¹ å®šä¹‰å’Œåº”ç”¨"],
    "topk": 3,
    "return_scores": True
}

# 3. æœç´¢ç»“æœ
response = {
    "result": [[
        {"document": {"contents": "\"æœºå™¨å­¦ä¹ æ¦‚è¿°\"\næœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯..."}},
        {"document": {"contents": "\"MLåŸºç¡€\"\næœºå™¨å­¦ä¹ ç®—æ³•é€šè¿‡æ•°æ®è®­ç»ƒ..."}}
    ]]
}

# 4. æ ¼å¼åŒ–ç»“æœ
search_result = "Doc 1(Title: æœºå™¨å­¦ä¹ æ¦‚è¿°) æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯...\nDoc 2(Title: MLåŸºç¡€) æœºå™¨å­¦ä¹ ç®—æ³•é€šè¿‡æ•°æ®è®­ç»ƒ...\n"

# 5. èå…¥å¯¹è¯ä¸Šä¸‹æ–‡
next_obs = "\n\n<information>Doc 1(Title: æœºå™¨å­¦ä¹ æ¦‚è¿°) æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯...\nDoc 2(Title: MLåŸºç¡€) æœºå™¨å­¦ä¹ ç®—æ³•é€šè¿‡æ•°æ®è®­ç»ƒ...\n</information>\n\n"
```

**è½®æ¬¡2: LLMåŸºäºæœç´¢ç»“æœç”Ÿæˆ**
```
è¾“å…¥: "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ\n\n<information>Doc 1(Title: æœºå™¨å­¦ä¹ æ¦‚è¿°) æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯...\nDoc 2(Title: MLåŸºç¡€) æœºå™¨å­¦ä¹ ç®—æ³•é€šè¿‡æ•°æ®è®­ç»ƒ...\n</information>\n\n"
LLMç”Ÿæˆ: "æ ¹æ®æœç´¢ç»“æœï¼Œ<answer>æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒä½¿è®¡ç®—æœºèƒ½å¤Ÿé€šè¿‡ç»éªŒè‡ªåŠ¨æ”¹è¿›æ€§èƒ½ï¼Œè€Œæ— éœ€æ˜ç¡®ç¼–ç¨‹ã€‚æœºå™¨å­¦ä¹ ç®—æ³•é€šè¿‡åˆ†æè®­ç»ƒæ•°æ®æ¥è¯†åˆ«æ¨¡å¼ï¼Œå¹¶åˆ©ç”¨è¿™äº›æ¨¡å¼å¯¹æ–°æ•°æ®åšå‡ºé¢„æµ‹æˆ–å†³ç­–ã€‚</answer>"
```

**è½®æ¬¡2: ç­”æ¡ˆå¤„ç†**
```python
# è§£æç­”æ¡ˆåŠ¨ä½œ
action = 'answer'
content = 'æ ¹æ®æœç´¢ç»“æœï¼Œæœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯...'

# å¯¹è¯ç»“æŸ
next_obs = ''  # ç­”æ¡ˆåæ— éœ€é¢å¤–ä¿¡æ¯
dones = 1      # å¯¹è¯ç»“æŸ
```

## æœç´¢åŠŸèƒ½çš„å…³é”®è®¾è®¡ç‰¹ç‚¹

1. **å¤šè½®æœç´¢æ”¯æŒ**: ç³»ç»Ÿæ”¯æŒåœ¨å•æ¬¡å¯¹è¯ä¸­è¿›è¡Œå¤šæ¬¡æœç´¢ï¼Œæ¯æ¬¡æœç´¢éƒ½ä¼šä¸°å¯Œä¸Šä¸‹æ–‡ï¼Œæ”¯æŒå¤æ‚çš„ä¿¡æ¯æ”¶é›†éœ€æ±‚ã€‚

2. **æ™ºèƒ½æˆªæ–­æœºåˆ¶**: é€šè¿‡_postprocess_responsesç¡®ä¿æ¯æ¬¡åªå¤„ç†ä¸€ä¸ªåŠ¨ä½œï¼Œé¿å…äº†å¤šä¸ªåŠ¨ä½œæ··åˆå¯¼è‡´çš„å¤æ‚æ€§å’Œä¸ç¡®å®šæ€§ã€‚

3. **çŠ¶æ€ä¸€è‡´æ€§**: é€šè¿‡active_maskç²¾ç¡®è·Ÿè¸ªæ¯ä¸ªå¯¹è¯å®ä¾‹çš„çŠ¶æ€ï¼Œç¡®ä¿æ‰¹å¤„ç†ä¸­ä¸åŒè¿›åº¦çš„å¯¹è¯èƒ½å¤Ÿæ­£ç¡®å¤„ç†ã€‚

4. **é”™è¯¯å®¹é”™**: å¯¹æ— æ•ˆåŠ¨ä½œæä¾›åé¦ˆè€Œéç»ˆæ­¢å¯¹è¯ï¼Œè®©æ¨¡å‹æœ‰æœºä¼šçº æ­£é”™è¯¯ï¼Œä½“ç°äº†è‰¯å¥½çš„äº¤äº’è®¾è®¡ã€‚

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **æ‰¹é‡å¤„ç†**: å°†å¤šä¸ªæœç´¢è¯·æ±‚åˆå¹¶ä¸ºå•æ¬¡HTTPè¯·æ±‚
2. **GPUå†…å­˜ç®¡ç†**: ä½¿ç”¨active_maskåªå¤„ç†æ´»è·ƒçš„å¯¹è¯å®ä¾‹
3. **é•¿åº¦æ§åˆ¶**: é™åˆ¶è§‚å¯Ÿç»“æœé•¿åº¦é˜²æ­¢å†…å­˜æº¢å‡º
4. **å¼‚æ­¥æ‰§è¡Œ**: æœç´¢æ‰§è¡Œä¸LLMç”Ÿæˆå¯ä»¥å¼‚æ­¥è¿›è¡Œ

## æ€»ç»“

`run_llm_loop`ä¸­çš„æœç´¢åŠŸèƒ½é€šè¿‡ä»¥ä¸‹10ä¸ªæ­¥éª¤å®ç°äº†å®Œæ•´çš„æ¨ç†-æœç´¢å¾ªç¯ï¼š

1. **LLMç”Ÿæˆå“åº”** - åŸºäºå½“å‰ä¸Šä¸‹æ–‡ç”Ÿæˆå¯èƒ½åŒ…å«æœç´¢æŒ‡ä»¤çš„æ–‡æœ¬
2. **å“åº”åå¤„ç†** - è§£æå¹¶æ ‡å‡†åŒ–åŠ¨ä½œæ ‡ç­¾ï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®
3. **æ‰§è¡Œé¢„æµ‹** - è°ƒç”¨execute_predictionså‡½æ•°å¤„ç†ç”Ÿæˆçš„åŠ¨ä½œ
4. **åŠ¨ä½œè§£æ** - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–åŠ¨ä½œç±»å‹å’Œå†…å®¹
5. **æŸ¥è¯¢æ”¶é›†** - æ‰¹é‡æ”¶é›†æ‰€æœ‰æœç´¢è¯·æ±‚ï¼Œä¼˜åŒ–å¤„ç†æ•ˆç‡
6. **æœç´¢æ‰§è¡Œ** - é€šè¿‡HTTP APIè°ƒç”¨æ£€ç´¢æœåŠ¡è·å–ç›¸å…³æ–‡æ¡£
7. **ç»“æœæ ¼å¼åŒ–** - å°†æ£€ç´¢ç»“æœè½¬æ¢ä¸ºæ˜“è¯»çš„æ–‡æœ¬æ ¼å¼
8. **ä¸Šä¸‹æ–‡èå…¥** - ç”¨<information>æ ‡ç­¾åŒ…è£…æœç´¢ç»“æœå¹¶åŠ å…¥å¯¹è¯
9. **çŠ¶æ€æ›´æ–°** - æ›´æ–°å¯¹è¯çŠ¶æ€ï¼Œå‡†å¤‡ä¸‹ä¸€è½®ç”Ÿæˆ
10. **å¾ªç¯ç»§ç»­** - åŸºäºæ–°çš„ä¸Šä¸‹æ–‡ç»§ç»­ç”Ÿæˆï¼Œç›´åˆ°è·å¾—æœ€ç»ˆç­”æ¡ˆ

è¿™ä¸ªç²¾å¦™çš„è®¾è®¡å®ç°äº†è¯­è¨€æ¨¡å‹ä¸å¤–éƒ¨çŸ¥è¯†æºçš„æ— ç¼é›†æˆï¼Œæ˜¯Search-R1é¡¹ç›®"æ¨ç†ä¸æœç´¢äº¤é”™"æ ¸å¿ƒç†å¿µçš„å®Œç¾ä½“ç°ã€‚

---

### é—®é¢˜ 7
ç”¨æˆ·ï¼šå½“å¯¹æ‰€æœ‰çš„queryæ‰§è¡Œäº†run_llm_loopå‡½æ•°åï¼Œæ˜¯ä¸æ˜¯ç”Ÿæˆäº†ç”¨äºRLè®­ç»ƒçš„æ•°æ®é›†ï¼Ÿæœ‰äº†æ•°æ®é›†å¦‚ä½•è¿›è¡Œåç»­çš„RLè®­ç»ƒå‘¢ï¼Ÿè¯·æ·±å…¥åˆ†æ
åŠ©æ‰‹ï¼šæˆ‘æ¥æ·±å…¥åˆ†æ`run_llm_loop`å‡½æ•°å¦‚ä½•ç”ŸæˆRLè®­ç»ƒæ•°æ®é›†ï¼Œä»¥åŠåç»­çš„RLè®­ç»ƒæµç¨‹ã€‚

## run_llm_loopç”ŸæˆRLè®­ç»ƒæ•°æ®é›†çš„æ·±åº¦åˆ†æ

### ä¸€ã€æ˜¯çš„ï¼Œrun_llm_loopç¡®å®ç”Ÿæˆäº†ç”¨äºRLè®­ç»ƒçš„æ•°æ®é›†

é€šè¿‡åˆ†æä»£ç ï¼Œå¯ä»¥ç¡®è®¤**`run_llm_loop`å‡½æ•°æ‰§è¡Œåç¡®å®ç”Ÿæˆäº†å®Œæ•´çš„å¼ºåŒ–å­¦ä¹ è®­ç»ƒæ•°æ®é›†**ã€‚è®©æˆ‘è¯¦ç»†è§£æè¿™ä¸ªæ•°æ®ç”Ÿæˆå’Œå¤„ç†æµç¨‹ã€‚

### äºŒã€run_llm_loopç”Ÿæˆçš„æ•°æ®ç»“æ„

#### **1. æ ¸å¿ƒè¾“å‡ºæ ¼å¼**

```python
# _compose_final_outputå‡½æ•°ç”Ÿæˆçš„æ•°æ®ç»“æ„
final_output = {
    'input_ids': torch.cat([left_side['input_ids'], right_side['responses']], dim=1),
    'attention_mask': torch.cat([
        self.tensor_fn.create_attention_mask(left_side['input_ids']),
        self.tensor_fn.create_attention_mask(final_output['responses'])
    ], dim=1),
    'info_mask': torch.cat([
        self.tensor_fn.create_attention_mask(left_side['input_ids']),
        self.tensor_fn.create_attention_mask(final_output['responses_with_info_mask'])
    ], dim=1),
    'position_ids': self.tensor_fn.create_position_ids(final_output['attention_mask']),
    'prompts': left_side['input_ids'],
    'responses': right_side['responses']
}
```

#### **2. å…ƒæ•°æ®ä¿¡æ¯**
```python
meta_info = {
    'turns_stats': turns_stats.tolist(),        # æ¯ä¸ªå¯¹è¯çš„è½®æ¬¡ç»Ÿè®¡
    'active_mask': active_mask.tolist(),       # æ´»è·ƒå¯¹è¯æ©ç 
    'valid_action_stats': valid_action_stats.tolist(),  # æœ‰æ•ˆåŠ¨ä½œç»Ÿè®¡
    'valid_search_stats': valid_search_stats.tolist()   # æœç´¢åŠ¨ä½œç»Ÿè®¡
}
```

**è½¨è¿¹æ•°æ®å®Œæ•´æ€§**: run_llm_loopç”Ÿæˆçš„æ¯ä¸ªæ ·æœ¬éƒ½åŒ…å«äº†å®Œæ•´çš„å¯¹è¯è½¨è¿¹ï¼ŒåŒ…æ‹¬åˆå§‹é—®é¢˜ã€æ‰€æœ‰æœç´¢åŠ¨ä½œã€æœç´¢ç»“æœå’Œæœ€ç»ˆç­”æ¡ˆï¼Œè¿™ä¸ºå¼ºåŒ–å­¦ä¹ æä¾›äº†ä¸°å¯Œçš„çŠ¶æ€-åŠ¨ä½œ-å¥–åŠ±åºåˆ—ã€‚

**å¤šç²’åº¦ä¿¡æ¯**: æ•°æ®ç»“æ„åŒæ—¶åŒ…å«tokençº§åˆ«çš„ä¿¡æ¯(å¦‚attention_maskã€position_ids)å’Œè½¨è¿¹çº§åˆ«çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œæ”¯æŒä¸åŒå±‚æ¬¡çš„å¼ºåŒ–å­¦ä¹ ç®—æ³•è®¾è®¡ã€‚

**æœç´¢è¡Œä¸ºè®°å½•**: é€šè¿‡valid_search_statsç­‰å…ƒæ•°æ®ï¼Œç³»ç»Ÿå¯ä»¥é‡åŒ–æ¨¡å‹çš„æœç´¢è¡Œä¸ºï¼Œä¸ºä¼˜åŒ–æœç´¢ç­–ç•¥æä¾›æ•°æ®åŸºç¡€ã€‚

### ä¸‰ã€PPOè®­ç»ƒçš„æ•°æ®æµç¨‹

#### **1. æ•°æ®ç”Ÿæˆé˜¶æ®µ (ray_trainer.pyæ ¸å¿ƒä»£ç )**

```python
# å…³é”®ä»£ç æ®µ
if self.config.do_search:
    first_input_ids = gen_batch.batch['input_ids'][:, -gen_config.max_start_length:].clone().long()

    # è°ƒç”¨run_llm_loopç”Ÿæˆå®Œæ•´è½¨è¿¹
    generation_manager = LLMGenerationManager(...)
    final_gen_batch_output = generation_manager.run_llm_loop(
        gen_batch=gen_batch,
        initial_input_ids=first_input_ids,
    )

    # è®¡ç®—ç­–ç•¥æ¦‚ç‡
    output = self.actor_rollout_wg.compute_log_prob(final_gen_batch_output)
    final_gen_batch_output = final_gen_batch_output.union(output)
```

#### **2. å¥–åŠ±è®¡ç®—é˜¶æ®µ (RewardManager)**

```python
class RewardManager:
    def __call__(self, data: DataProto):
        reward_tensor = torch.zeros_like(data.batch['responses'], dtype=torch.float32)

        for i in range(len(data)):
            data_item = data[i]

            # æå–å®Œæ•´çš„å¯¹è¯åºåˆ—
            prompt_ids = data_item.batch['prompts']
            response_ids = data_item.batch['responses']
            sequences = torch.cat((prompt_ids, response_ids))
            sequences_str = self.tokenizer.decode(sequences)

            # è·å–æ ‡å‡†ç­”æ¡ˆ
            ground_truth = data_item.non_tensor_batch['reward_model']['ground_truth']

            # æ ¹æ®æ•°æ®æºé€‰æ‹©è¯„åˆ†å‡½æ•°
            data_source = data_item.non_tensor_batch['data_source']
            compute_score_fn = _select_rm_score_fn(data_source)

            # è®¡ç®—å¥–åŠ±åˆ†æ•°
            score = compute_score_fn(
                solution_str=sequences_str,
                ground_truth=ground_truth,
                format_score=self.format_score
            )

            # å°†å¥–åŠ±åˆ†é…ç»™åºåˆ—çš„æœ€åä¸€ä¸ªtoken
            reward_tensor[i, valid_response_length - 1] = score
```

#### **3. å¥–åŠ±è¯„åˆ†å‡½æ•°è¯¦è§£**

```python
def _select_rm_score_fn(data_source):
    if data_source in ['nq', 'triviaqa', 'popqa', 'hotpotqa', '2wikimultihopqa', 'musique', 'bamboogle']:
        return qa_em.compute_score_em  # Exact Matchè¯„åˆ†
    else:
        raise NotImplementedError
```

**Exact Match (EM) è¯„åˆ†æœºåˆ¶**:
- **å®Œå…¨åŒ¹é…**: æ¨¡å‹ç­”æ¡ˆä¸æ ‡å‡†ç­”æ¡ˆå®Œå…¨ä¸€è‡´æ—¶å¾—1åˆ†
- **éƒ¨åˆ†åŒ¹é…**: é€šè¿‡æ ‡å‡†åŒ–å¤„ç†ï¼ˆå°å†™è½¬æ¢ã€æ ‡ç‚¹ç§»é™¤ç­‰ï¼‰è¿›è¡Œè½¯åŒ¹é…
- **æ ¼å¼å¥–åŠ±**: å¯¹æ­£ç¡®ä½¿ç”¨æœç´¢å’Œå›ç­”æ ‡ç­¾çš„æ ¼å¼ç»™äºˆé¢å¤–å¥–åŠ±

### å››ã€å®Œæ•´çš„PPOè®­ç»ƒæµç¨‹

**æ•°æ®é—­ç¯**: run_llm_loopç”Ÿæˆè½¨è¿¹ â†’ å¥–åŠ±è®¡ç®— â†’ PPOæ›´æ–° â†’ æ–°ç­–ç•¥ â†’ æ–°è½¨è¿¹ï¼Œå½¢æˆäº†å®Œæ•´çš„å¼ºåŒ–å­¦ä¹ é—­ç¯ã€‚

**æœç´¢ä¼˜åŒ–**: é€šè¿‡å¥–åŠ±ä¿¡å·ï¼Œæ¨¡å‹å­¦ä¼šä½•æ—¶éœ€è¦æœç´¢ã€æœç´¢ä»€ä¹ˆå†…å®¹ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨æœç´¢ç»“æœï¼Œå®ç°äº†æœç´¢è¡Œä¸ºçš„è‡ªé€‚åº”ä¼˜åŒ–ã€‚

**å¤šç›®æ ‡å¹³è¡¡**: ç³»ç»ŸåŒæ—¶ä¼˜åŒ–ç­”æ¡ˆå‡†ç¡®æ€§å’Œæœç´¢æ•ˆç‡ï¼Œé€šè¿‡æ ¼å¼å¥–åŠ±é¼“åŠ±æ­£ç¡®çš„äº¤äº’æ¨¡å¼ã€‚

#### **é˜¶æ®µ1: æ•°æ®ç”Ÿæˆ (Generation Phase)**
```python
# 1.1 åŠ è½½å½“å‰ç­–ç•¥æ¨¡å‹
actor_rollout_wg = ActorRolloutRefWorker(model_path)

# 1.2 ç”Ÿæˆå¯¹è¯è½¨è¿¹
generation_manager = LLMGenerationManager(
    config=GenerationConfig(
        max_turns=2,
        max_start_length=2048,
        max_response_length=500,
        max_obs_length=500,
        search_url="http://127.0.0.1:8000/retrieve",
        topk=3
    )
)

# 1.3 æ‰¹é‡ç”Ÿæˆè½¨è¿¹
trajectories = generation_manager.run_llm_loop(gen_batch, initial_input_ids)
```

#### **é˜¶æ®µ2: å¥–åŠ±è®¡ç®— (Reward Phase)**
```python
# 2.1 è§£ç è½¨è¿¹æ–‡æœ¬
trajectory_texts = tokenizer.decode(trajectory_tokens)

# 2.2 è®¡ç®—å¥–åŠ±åˆ†æ•°
rewards = reward_fn(trajectories)  # åŸºäºEMè¯„åˆ†

# 2.3 åˆ†é…å¥–åŠ±åˆ°åºåˆ—
reward_tensor = allocate_rewards_to_tokens(rewards, trajectory_lengths)
```

#### **é˜¶æ®µ3: å‚è€ƒç­–ç•¥è®¡ç®— (Reference Policy Phase)**
```python
# 3.1 ä½¿ç”¨å†»ç»“çš„å‚è€ƒç­–ç•¥è®¡ç®—æ—§æ¦‚ç‡
with torch.no_grad():
    ref_log_probs = ref_policy.compute_log_prob(trajectories)
```

#### **é˜¶æ®µ4: ä¼˜åŠ¿å‡½æ•°è®¡ç®— (Advantage Computation)**
```python
# 4.1 è®¡ç®—ä»·å€¼å‡½æ•°
values = critic.compute_values(trajectories)

# 4.2 è®¡ç®—ä¼˜åŠ¿å‡½æ•° (GAEç®—æ³•)
advantages = compute_gae_advantages(
    rewards=reward_tensor,
    values=values,
    discount_factor=0.99,
    gae_lambda=0.95
)
```

#### **é˜¶æ®µ5: PPOæ›´æ–° (Policy Update Phase)**
```python
# 5.1 è®¡ç®—ç­–ç•¥æ¯”ç‡
ratio = torch.exp(current_log_probs - ref_log_probs)

# 5.2 PPOç›®æ ‡å‡½æ•°
surrogate1 = ratio * advantages
surrogate2 = torch.clamp(ratio, 1-epsilon, 1+epsilon) * advantages
policy_loss = -torch.min(surrogate1, surrogate2).mean()

# 5.3 è®¡ç®—KLæ•£åº¦æƒ©ç½š
kl_penalty = compute_kl_penalty(current_policy, ref_policy)

# 5.4 æ€»æŸå¤±
total_loss = policy_loss + value_loss + kl_penalty_coef * kl_penalty

# 5.5 åå‘ä¼ æ’­æ›´æ–°
total_loss.backward()
optimizer.step()
```

### äº”ã€è®­ç»ƒé…ç½®å…³é”®å‚æ•°

ä»`train_ppo.sh`å’Œé…ç½®æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°å…³é”®å‚æ•°ï¼š

```yaml
# æ•°æ®é…ç½®
data:
  max_prompt_length: 4096      # æœ€å¤§æç¤ºé•¿åº¦
  max_response_length: 500     # æœ€å¤§å“åº”é•¿åº¦
  max_start_length: 2048       # æœ€å¤§èµ·å§‹é•¿åº¦
  max_obs_length: 500          # æœ€å¤§è§‚å¯Ÿé•¿åº¦
  train_batch_size: 512        # è®­ç»ƒæ‰¹æ¬¡å¤§å°

# æœç´¢é…ç½®
retriever:
  url: "http://127.0.0.1:8000/retrieve"  # æ£€ç´¢æœåŠ¡URL
  topk: 3                               # æ£€ç´¢æ–‡æ¡£æ•°é‡

# PPOç®—æ³•é…ç½®
actor_rollout_ref:
  actor:
    ppo_mini_batch_size: 256    # PPOå°æ‰¹æ¬¡å¤§å°
    ppo_micro_batch_size: 64    # PPOå¾®æ‰¹æ¬¡å¤§å°
    clip_ratio: 0.2             # PPOè£å‰ªæ¯”ç‡
    entropy_coeff: 0.001        # ç†µç³»æ•°

# è®­ç»ƒæ§åˆ¶
trainer:
  total_epochs: 15             # æ€»è®­ç»ƒè½®æ•°
  total_training_steps: 1005   # æ€»è®­ç»ƒæ­¥æ•°
  save_freq: 100               # ä¿å­˜é¢‘ç‡
```

### å…­ã€æ•°æ®æµå‘å›¾

```
ç”¨æˆ·é—®é¢˜ â†’ run_llm_loop â†’ å®Œæ•´å¯¹è¯è½¨è¿¹ â†’ å¥–åŠ±è®¡ç®— â†’ PPOæ›´æ–°
    â†“                                    â†“
[åˆå§‹çŠ¶æ€] â†’ [æœç´¢åŠ¨ä½œ1] â†’ [æœç´¢ç»“æœ1] â†’ [æœç´¢åŠ¨ä½œ2] â†’ [æœ€ç»ˆç­”æ¡ˆ]
    â†“            â†“             â†“             â†“           â†“
çŠ¶æ€s0       åŠ¨ä½œa1        å¥–åŠ±r1        åŠ¨ä½œa2     å¥–åŠ±r_final
    â†“            â†“             â†“             â†“           â†“
ç­–ç•¥Ï€Î¸(s0) â†’ æœç´¢æŸ¥è¯¢ â†’ ç›¸å…³æ–‡æ¡£ â†’ æ–°æŸ¥è¯¢ â†’ æœ€ç»ˆç­”æ¡ˆ
```

## æ€»ç»“

**æ˜¯çš„ï¼Œå¯¹queryæ‰§è¡Œ`run_llm_loop`å‡½æ•°åç¡®å®ç”Ÿæˆäº†ç”¨äºRLè®­ç»ƒçš„å®Œæ•´æ•°æ®é›†ã€‚**

è¿™ä¸ªæ•°æ®é›†åŒ…å«äº†ï¼š
1. **å®Œæ•´çš„å¯¹è¯è½¨è¿¹**: ä»åˆå§‹é—®é¢˜åˆ°æœ€ç»ˆç­”æ¡ˆçš„å®Œæ•´äº¤äº’è¿‡ç¨‹
2. **æœç´¢è¡Œä¸ºè®°å½•**: ä½•æ—¶æœç´¢ã€æœç´¢ä»€ä¹ˆã€æœç´¢ç»“æœå¦‚ä½•è¢«ä½¿ç”¨
3. **çŠ¶æ€-åŠ¨ä½œåºåˆ—**: ç”¨äºå¼ºåŒ–å­¦ä¹ çš„è®­ç»ƒæ ·æœ¬
4. **å¥–åŠ±ä¿¡å·**: åŸºäºç­”æ¡ˆè´¨é‡çš„è¯„ä¼°åˆ†æ•°

åç»­çš„RLè®­ç»ƒé€šè¿‡ä»¥ä¸‹æ­¥éª¤è¿›è¡Œï¼š

1. **æ•°æ®ç”Ÿæˆ**: ä½¿ç”¨å½“å‰ç­–ç•¥æ¨¡å‹ç”Ÿæˆå¯¹è¯è½¨è¿¹
2. **å¥–åŠ±è®¡ç®—**: ä½¿ç”¨Exact Matchç­‰æŒ‡æ ‡è¯„ä¼°è½¨è¿¹è´¨é‡
3. **ä¼˜åŠ¿ä¼°è®¡**: ä½¿ç”¨GAEç®—æ³•è®¡ç®—ä¼˜åŠ¿å‡½æ•°
4. **ç­–ç•¥æ›´æ–°**: ä½¿ç”¨PPOç®—æ³•æ›´æ–°æ¨¡å‹å‚æ•°
5. **è¿­ä»£ä¼˜åŒ–**: é‡å¤ä¸Šè¿°è¿‡ç¨‹ï¼Œé€æ­¥æå‡æ¨¡å‹çš„æœç´¢å’Œæ¨ç†èƒ½åŠ›

è¿™ä¸ªç²¾å¦™çš„è®¾è®¡å®ç°äº†è¯­è¨€æ¨¡å‹ä»"å­¦ä¼šæœç´¢"åˆ°"å­¦ä¼šå¦‚ä½•æœ‰æ•ˆæœç´¢"çš„è¿›åŒ–ï¼Œæ˜¯Search-R1é¡¹ç›®å®ç°"æ¨ç†ä¸æœç´¢äº¤é”™"è®­ç»ƒæ¨¡å¼çš„æ ¸å¿ƒæœºåˆ¶ã€‚