# Chat Dialogue Log

## å¯¹è¯æ—¶é—´
2025-10-16 20:07:24

---

## å¯¹è¯å†…å®¹

### é—®é¢˜ 1
ç”¨æˆ·ï¼šæˆ‘æ„Ÿè§‰æ•´ä¸ªé¡¹ç›®æœ€é‡è¦çš„å°±æ˜¯verlå’Œsearch_r1è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹ã€‚è¯·ç»™å‡ºæ·±åº¦åˆ†æï¼

åŠ©æ‰‹ï¼šæˆ‘æ¥ä¸ºæ‚¨æ·±åº¦åˆ†æ Search-R1 é¡¹ç›®çš„ä¸¤ä¸ªæ ¸å¿ƒæ¨¡å—ï¼š`verl` å’Œ `search_r1`ã€‚è®©æˆ‘å…ˆåˆ›å»ºä¸€ä¸ªä»»åŠ¡è®¡åˆ’æ¥ç³»ç»Ÿæ€§åœ°åˆ†æè¿™ä¸¤ä¸ªå…³é”®ç»„ä»¶ã€‚

# Search-R1 æ¨¡å—æ¶æ„è®¾è®¡æ·±åº¦åˆ†ææŠ¥å‘Š

## 1. æ ¸å¿ƒç±»å’Œæ¥å£çš„è®¾è®¡æ€æƒ³

### 1.1 æŠ½è±¡å±‚æ¬¡è®¾è®¡

Search-R1 é‡‡ç”¨äº†éå¸¸æ¸…æ™°çš„åˆ†å±‚æŠ½è±¡æ¶æ„ï¼š

```
LLM Generation Layer (LLMGenerationManager)
         â†“
   Search Execution Layer (execute_predictions)
         â†“
  Retrieval Service Layer (FastAPI Servers)
         â†“
   Index Implementation Layer (BaseRetriever)
```

è¿™ç§åˆ†å±‚è®¾è®¡çš„ä¼˜åŠ¿åœ¨äºï¼š
- **èŒè´£åˆ†ç¦»**ï¼šæ¯ä¸€å±‚åªè´Ÿè´£ç‰¹å®šçš„åŠŸèƒ½ï¼Œé™ä½è€¦åˆæ€§
- **å¯æ‰©å±•æ€§**ï¼šæ–°çš„æ£€ç´¢æ–¹æ³•å¯ä»¥è½»æ¾æ·»åŠ åˆ°åº•å±‚ï¼Œè€Œä¸å½±å“ä¸Šå±‚é€»è¾‘
- **å¯æµ‹è¯•æ€§**ï¼šæ¯ä¸€å±‚éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•

### 1.2 æ¥å£è®¾è®¡çš„åˆ›æ–°ç‚¹

#### BaseRetriever æŠ½è±¡åŸºç±»
```python
class BaseRetriever:
    def _search(self, query: str, num: int, return_score:bool)
    def _batch_search(self, query_list, num, return_score)
```

è¿™ä¸ªè®¾è®¡ä½“ç°äº†"æœ€å°æ¥å£åŸåˆ™"ï¼š
- åªå®šä¹‰æœ€æ ¸å¿ƒçš„æœç´¢æ“ä½œ
- å…·ä½“å®ç°ç”±å­ç±»å®Œæˆ
- æä¾›äº†ç»Ÿä¸€çš„è®¿é—®æ¥å£ï¼Œæ”¯æŒå¤šæ€

#### FastAPI æœåŠ¡æ¨¡å¼
å°†æ£€ç´¢åŠŸèƒ½å°è£…ä¸ºå¾®æœåŠ¡æ¶æ„ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å·§å¦™çš„è®¾è®¡ï¼š
- **è§£è€¦åˆ**ï¼šæ¨ç†æ¨¡å—å’Œæ£€ç´¢æ¨¡å—é€šè¿‡ HTTP API é€šä¿¡
- **å¯æ‰©å±•æ€§**ï¼šå¯ä»¥ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•æ£€ç´¢æœåŠ¡
- **çµæ´»æ€§**ï¼šæ”¯æŒå¤šç§æ£€ç´¢å¼•æ“ï¼ˆBM25ã€Denseã€Google Searchï¼‰

## 2. LLM Agent å¦‚ä½•ç®¡ç†æ¨ç†å’Œæœç´¢çš„äº¤äº’

### 2.1 çŠ¶æ€ç®¡ç†æœºåˆ¶

LLMGenerationManager é‡‡ç”¨äº†**åŒå±‚çŠ¶æ€ç®¡ç†**ï¼š

```python
original_left_side = {'input_ids': initial_input_ids[:, -self.config.max_start_length:]}
original_right_side = {'responses': initial_input_ids[:, []], 'responses_with_info_mask': initial_input_ids[:, []]}
rollings = gen_batch
```

- **left_side**: å­˜å‚¨åŸå§‹æç¤ºè¯ï¼Œä¿æŒä¸å˜
- **right_side**: åŠ¨æ€ç´¯ç§¯ç”Ÿæˆçš„å“åº”å’Œæœç´¢ç»“æœ
- **rollings**: ç”¨äºæ¨¡å‹ç”Ÿæˆçš„å½“å‰çŠ¶æ€

è¿™ç§è®¾è®¡çš„å·§å¦™ä¹‹å¤„åœ¨äºï¼š
- åˆ†ç¦»äº†é™æ€å’ŒåŠ¨æ€å†…å®¹
- æ”¯æŒå¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡ç®¡ç†
- ä¾¿äºè¿½è¸ªå®Œæ•´çš„æ¨ç†-æœç´¢å†å²

### 2.2 æ¨ç†-æœç´¢äº¤äº’å¾ªç¯

æ ¸å¿ƒäº¤äº’æœºåˆ¶åœ¨ `run_llm_loop` æ–¹æ³•ä¸­ï¼š

```python
for step in range(self.config.max_turns):
    # 1. ç”Ÿæˆå“åº”
    gen_output = self._generate_with_gpu_padding(rollings_active)

    # 2. è§£æåŠ¨ä½œï¼ˆæœç´¢æˆ–å›ç­”ï¼‰
    responses_ids, responses_str = self._postprocess_responses(gen_output.batch['responses'])

    # 3. æ‰§è¡ŒåŠ¨ä½œ
    next_obs, dones, valid_action, is_search = self.execute_predictions(
        responses_str, self.tokenizer.pad_token, active_mask
    )

    # 4. æ›´æ–°çŠ¶æ€
    rollings = self._update_rolling_state(rollings, responses_ids, next_obs_ids)
```

è¿™ä¸ªå¾ªç¯ä½“ç°äº†**å·¥å…·å¢å¼ºçš„æ¨ç†èŒƒå¼**ï¼š
- LLM å†³å®šä½•æ—¶æœç´¢
- ç³»ç»Ÿæ‰§è¡Œæœç´¢å¹¶è¿”å›ç»“æœ
- LLM åŸºäºæœç´¢ç»“æœç»§ç»­æ¨ç†
- å¾ªç¯ç›´åˆ°å¾—å‡ºæœ€ç»ˆç­”æ¡ˆ

### 2.3 åŠ¨ä½œè§£ææœºåˆ¶

é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è§£æ LLM è¾“å‡ºï¼š
```python
pattern = r'<(search|answer)>(.*?)</\1>'
match = re.search(pattern, prediction, re.DOTALL)
```

è¿™ç§è®¾è®¡çš„ä¼˜ç‚¹ï¼š
- **ç»“æ„åŒ–è¾“å‡º**ï¼šå¼ºåˆ¶ LLM ä½¿ç”¨æ ‡å‡†æ ¼å¼
- **å¯æ‰©å±•æ€§**ï¼šå¯ä»¥è½»æ¾æ·»åŠ æ–°çš„åŠ¨ä½œç±»å‹
- **è§£æç®€å•**ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼é«˜æ•ˆè§£æ

## 3. æ£€ç´¢ç³»ç»Ÿçš„æ¶æ„å’Œä¸åŒæ£€ç´¢æ–¹æ³•çš„å®ç°

### 3.1 æ£€ç´¢å™¨ç»§æ‰¿ä½“ç³»

```
BaseRetriever (æŠ½è±¡åŸºç±»)
    â”œâ”€â”€ BM25Retriever (ç¨€ç–æ£€ç´¢)
    â””â”€â”€ DenseRetriever (å¯†é›†æ£€ç´¢)
```

è¿™ç§ç»§æ‰¿è®¾è®¡çš„ä¼˜åŠ¿ï¼š
- **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰æ£€ç´¢å™¨éƒ½æœ‰ç›¸åŒçš„æ–¹æ³•ç­¾å
- **ä»£ç å¤ç”¨**ï¼šå…¬å…±åŠŸèƒ½åœ¨åŸºç±»ä¸­å®ç°
- **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°çš„æ£€ç´¢æ–¹æ³•åªéœ€å®ç°åŸºç±»æ¥å£

### 3.2 æ£€ç´¢æ–¹æ³•çš„æŠ€æœ¯å®ç°

#### BM25Retriever
- åŸºäº Pyserini çš„ Lucene æœç´¢å¼•æ“
- æ”¯æŒä¸¤ç§æ¨¡å¼ï¼šç´¢å¼•å†…å«æ–‡æ¡£å†…å®¹ vs å¤–éƒ¨è¯­æ–™
- æ‰¹é‡å¤„ç†é€šè¿‡ç®€å•çš„å¾ªç¯å®ç°

#### DenseRetriever
- åŸºäº FAISS å‘é‡ç´¢å¼•
- æ”¯æŒå¤šç§ç¼–ç å™¨ï¼ˆE5ã€BGEã€DPRï¼‰
- GPU åŠ é€Ÿå’Œæ‰¹é‡å¤„ç†
- è‡ªåŠ¨å†…å­˜ç®¡ç†å’Œç¼“å­˜æ¸…ç†

### 3.3 å¼‚æ„æ£€ç´¢æœåŠ¡

ç³»ç»Ÿæ”¯æŒä¸‰ç§æ£€ç´¢æœåŠ¡ï¼š

1. **æœ¬åœ°æ£€ç´¢æœåŠ¡** (`retrieval_server.py`)
   - åŸºäº FastAPI çš„é«˜æ€§èƒ½æœåŠ¡
   - æ”¯æŒ BM25 å’Œ Dense æ£€ç´¢
   - æ‰¹é‡å¤„ç†å’Œ GPU åŠ é€Ÿ

2. **é‡æ’åºæœåŠ¡** (`rerank_server.py`)
   - åŸºäº CrossEncoder çš„äºŒé˜¶æ®µæ£€ç´¢
   - æé«˜æ£€ç´¢ç²¾åº¦
   - æ”¯æŒå¤šç§é‡æ’åºæ¨¡å‹

3. **åœ¨çº¿æœç´¢æœåŠ¡** (`google_search_server.py`)
   - é›†æˆ Google Search API
   - å¼‚æ­¥ç½‘é¡µå†…å®¹è·å–
   - å†…å®¹è¿‡æ»¤å’Œæ ¼å¼åŒ–

## 4. å„ä¸ªå­æ¨¡å—ä¹‹é—´çš„åä½œå…³ç³»

### 4.1 æ¨¡å—é—´é€šä¿¡æœºåˆ¶

```
LLMGenerationManager (æ¨ç†)
      â†“ HTTP API
Retrieval Server (æ£€ç´¢)
      â†“ HTTP API
Rerank Server (é‡æ’åº)
```

è¿™ç§å¾®æœåŠ¡æ¶æ„çš„ä¼˜åŠ¿ï¼š
- **æ¾è€¦åˆ**ï¼šå„æ¨¡å—å¯ä»¥ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
- **å¯æ‰©å±•**ï¼šå¯ä»¥æ°´å¹³æ‰©å±•å„ä¸ªæœåŠ¡
- **å®¹é”™æ€§**ï¼šå•ä¸ªæœåŠ¡çš„æ•…éšœä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿ

### 4.2 æ•°æ®æµè®¾è®¡

```python
# æŸ¥è¯¢æµç¨‹
queries â†’ LLMGenerationManager â†’ HTTPè¯·æ±‚ â†’ Retrieval Server â†’
æ–‡æ¡£ â†’ Rerank Server â†’ æœ€ç»ˆç»“æœ â†’ LLMGenerationManager
```

æ•°æ®æµçš„è®¾è®¡ç‰¹ç‚¹ï¼š
- **æ ‡å‡†åŒ–æ ¼å¼**ï¼šä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®ç»“æ„
- **æ‰¹å¤„ç†ä¼˜åŒ–**ï¼šæ”¯æŒæ‰¹é‡æŸ¥è¯¢æé«˜æ•ˆç‡
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

## 5. ä»£ç çš„è®¾è®¡æ¨¡å¼å’ŒæŠ€æœ¯äº®ç‚¹

### 5.1 è®¾è®¡æ¨¡å¼åº”ç”¨

#### ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
- ä¸åŒæ£€ç´¢æ–¹æ³•å®ç°åŒä¸€æ¥å£
- å¯ä»¥åœ¨è¿è¡Œæ—¶åˆ‡æ¢æ£€ç´¢ç­–ç•¥
- æ˜“äºæ·»åŠ æ–°çš„æ£€ç´¢ç®—æ³•

#### å·¥å‚æ¨¡å¼ (Factory Pattern)
```python
def get_retriever(config):
    if config.retrieval_method == "bm25":
        return BM25Retriever(config)
    else:
        return DenseRetriever(config)
```

- æ ¹æ®é…ç½®è‡ªåŠ¨åˆ›å»ºåˆé€‚çš„æ£€ç´¢å™¨
- éšè—å…·ä½“å®ç°ç»†èŠ‚
- ä¾¿äºæ‰©å±•æ–°çš„æ£€ç´¢å™¨ç±»å‹

#### æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)
- BaseRetriever å®šä¹‰ç®—æ³•éª¨æ¶
- å­ç±»å®ç°å…·ä½“æ­¥éª¤
- ä¿è¯ç®—æ³•ç»“æ„çš„ä¸€è‡´æ€§

### 5.2 æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

#### å†…å­˜ç®¡ç†
```python
del batch_emb, batch_scores, batch_idxs, query_batch, flat_idxs, batch_results
torch.cuda.empty_cache()
```
- åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„å¼ é‡
- æ¸…ç† GPU ç¼“å­˜
- é¿å…å†…å­˜æ³„æ¼

#### æ‰¹å¤„ç†ä¼˜åŒ–
- æ”¯æŒæ‰¹é‡ç¼–ç å’Œæ£€ç´¢
- GPU å¹¶è¡Œè®¡ç®—
- åŠ¨æ€æ‰¹æ¬¡å¤§å°è°ƒæ•´

#### å¤šGPUæ”¯æŒ
```python
def _generate_with_gpu_padding(self, active_batch: DataProto):
    if num_gpus <= 1:
        return self.actor_rollout_wg.generate_sequences(active_batch)
    # æ·»åŠ å¡«å……åºåˆ—ä½¿å…¶èƒ½è¢« num_gpus æ•´é™¤
    padding_size = num_gpus - remainder
```
- è‡ªåŠ¨å¤„ç†æ‰¹æ¬¡å¤§å°ä¸GPUæ•°é‡çš„åŒ¹é…
- åŠ¨æ€å¡«å……å’Œè£å‰ª
- é€æ˜çš„å¤šGPUå¹¶è¡Œ

### 5.3 å¼‚æ­¥å¤„ç†å’Œå¹¶å‘æ§åˆ¶

#### å¼‚æ­¥ç½‘é¡µæŠ“å–
```python
async def fetch_all(urls: List[str], limit: int = 8) -> List[str]:
    semaphore = asyncio.Semaphore(limit)
    async with aiohttp.ClientSession(...) as session:
        tasks = [fetch(session, url, semaphore) for url in urls]
        return await asyncio.gather(*tasks)
```
- å¹¶å‘è·å–å¤šä¸ªç½‘é¡µå†…å®¹
- ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°
- è¶…æ—¶å’Œé”™è¯¯å¤„ç†

#### çº¿ç¨‹æ± å¤„ç†
```python
def batch_search(self, queries: List[str]) -> List[List[str]]:
    with ThreadPoolExecutor() as executor:
        return list(executor.map(self._retrieve_context, queries))
```
- å¹¶è¡Œå¤„ç†å¤šä¸ªæŸ¥è¯¢
- çº¿ç¨‹æ± å¤ç”¨
- ç®€å•çš„å¹¶è¡Œæ¨¡å¼

### 5.4 APIè®¾è®¡å’Œæ¨¡å—è§£è€¦

#### RESTful APIè®¾è®¡
- ç»Ÿä¸€çš„è¯·æ±‚/å“åº”æ ¼å¼
- æ¸…æ™°çš„ç«¯ç‚¹å‘½å
- å®Œå–„çš„é”™è¯¯å¤„ç†

#### é…ç½®é©±åŠ¨
```python
@dataclass
class GenerationConfig:
    max_turns: int
    max_start_length: int
    max_prompt_length: int
    # ...
```
- ä½¿ç”¨ dataclass å®šä¹‰é…ç½®
- ç±»å‹å®‰å…¨çš„é…ç½®ç®¡ç†
- æ˜“äºæ‰©å±•å’Œä¿®æ”¹

## æ€»ç»“

Search-R1 æ¨¡å—çš„æ¶æ„è®¾è®¡ä½“ç°äº†ä»¥ä¸‹åˆ›æ–°ç‚¹ï¼š

1. **åˆ†å±‚æŠ½è±¡**ï¼šæ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼ŒèŒè´£åˆ†ç¦»æ˜ç¡®
2. **å¾®æœåŠ¡åŒ–**ï¼šæ£€ç´¢åŠŸèƒ½ç‹¬ç«‹æœåŠ¡ï¼Œæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
3. **å¤šç­–ç•¥æ£€ç´¢**ï¼šæ”¯æŒå¤šç§æ£€ç´¢æ–¹æ³•ï¼Œå¯çµæ´»åˆ‡æ¢
4. **æ¨ç†-æœç´¢äº¤äº’**ï¼šåˆ›æ–°çš„å·¥å…·å¢å¼ºæ¨ç†èŒƒå¼
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤šå±‚æ¬¡çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
6. **æ‰©å±•æ€§**ï¼šè‰¯å¥½çš„æ¥å£è®¾è®¡ï¼Œæ˜“äºæ‰©å±•æ–°åŠŸèƒ½

è¿™ä¸ªæ¶æ„ä¸ä»…è§£å†³äº†å½“å‰çš„éœ€æ±‚ï¼Œè¿˜ä¸ºæœªæ¥çš„æ‰©å±•å’Œä¼˜åŒ–æä¾›äº†è‰¯å¥½çš„åŸºç¡€ã€‚ç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§è§„æ¨¡çŸ¥è¯†æ£€ç´¢å’Œå¤æ‚æ¨ç†ä»»åŠ¡æ–¹é¢ï¼Œå±•ç°äº†å¼ºå¤§çš„èƒ½åŠ›ã€‚

---

### é—®é¢˜ 2
ç”¨æˆ·ï¼šè¯·è¯¦ç»†è§£é‡Šsearch_r1æ–‡ä»¶å¤¹çš„ä½œç”¨ï¼Œå¹¶åˆ†æå…¶å†…éƒ¨æ–‡ä»¶çš„åŠŸèƒ½ï¼

åŠ©æ‰‹ï¼š# Search-R1 æ¨¡å—è¯¦ç»†åŠŸèƒ½åˆ†æ

## 1. Search-R1 æ–‡ä»¶å¤¹çš„æ•´ä½“ä½œç”¨å’Œå®šä½

`search_r1` æ˜¯æ•´ä¸ª Search-R1 é¡¹ç›®çš„**æ ¸å¿ƒæ¨ç†ä¸æœç´¢å¼•æ“**ï¼Œè´Ÿè´£å®ç°è¯­è¨€æ¨¡å‹ä¸å¤–éƒ¨çŸ¥è¯†æºçš„äº¤äº’ã€‚å®ƒçš„ä¸»è¦å®šä½åŒ…æ‹¬ï¼š

### 1.1 æ ¸å¿ƒåŠŸèƒ½å®šä½
- **æ¨ç†-æœç´¢åè°ƒå™¨**ï¼šç®¡ç† LLM ä¸æ£€ç´¢ç³»ç»Ÿçš„äº¤äº’å¾ªç¯
- **çŸ¥è¯†å¢å¼ºå¼•æ“**ï¼šä¸ºè¯­è¨€æ¨¡å‹æä¾›å¤–éƒ¨çŸ¥è¯†å’Œäº‹å®ä¿¡æ¯
- **å·¥å…·æŠ½è±¡å±‚**ï¼šå°†å„ç§æ£€ç´¢æ–¹æ³•ç»Ÿä¸€ä¸ºæ ‡å‡†æ¥å£
- **å¾®æœåŠ¡åŸºç¡€è®¾æ–½**ï¼šæä¾›åˆ†å¸ƒå¼çš„æ£€ç´¢å’Œæ¨ç†æœåŠ¡

### 1.2 æ¶æ„è®¾è®¡ç†å¿µ
```
search_r1/
â”œâ”€â”€ llm_agent/          # LLMä»£ç†å’Œç”Ÿæˆç®¡ç†
â””â”€â”€ search/             # æ£€ç´¢ç³»ç»Ÿå®ç°
```

è¿™ç§äºŒå…ƒæ¶æ„ä½“ç°äº†**æ¨ç†ä¸æ£€ç´¢åˆ†ç¦»**çš„è®¾è®¡æ€æƒ³ï¼Œä½¿å¾—ä¸¤ä¸ªå­ç³»ç»Ÿå¯ä»¥ç‹¬ç«‹å¼€å‘å’Œæ‰©å±•ã€‚

## 2. LLM Agent å­æ¨¡å—è¯¦ç»†åˆ†æ

`llm_agent` å­æ¨¡å—æ˜¯æ•´ä¸ªç³»ç»Ÿçš„**æ™ºèƒ½æ§åˆ¶ä¸­æ¢**ï¼Œè´Ÿè´£åè°ƒè¯­è¨€æ¨¡å‹ä¸æ£€ç´¢ç³»ç»Ÿçš„äº¤äº’ã€‚

### 2.1 LLMGenerationManagerï¼ˆæ ¸å¿ƒæ§åˆ¶å™¨ï¼‰

#### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼š

1. **å¤šè½®æ¨ç†å¾ªç¯ç®¡ç†**
   - `run_llm_loop()`: ä¸»æ§åˆ¶å¾ªç¯ï¼Œç®¡ç†æ•´ä¸ªæ¨ç†-æœç´¢è¿‡ç¨‹
   - æ”¯æŒæœ€å¤š `max_turns` è½®äº¤äº’
   - æ™ºèƒ½çš„æ´»è·ƒçŠ¶æ€ç®¡ç†ï¼Œé¿å…æ— æ•ˆè®¡ç®—

2. **åŠ¨ä½œè§£æä¸æ‰§è¡Œ**
   - `_postprocess_responses()`: è§£æLLMç”Ÿæˆçš„ç»“æ„åŒ–åŠ¨ä½œ
   - `execute_predictions()`: æ‰§è¡Œæœç´¢æˆ–å›ç­”åŠ¨ä½œ
   - æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼è§£æï¼š`<search>æŸ¥è¯¢</search>` å’Œ `<answer>ç­”æ¡ˆ</answer>`

3. **çŠ¶æ€ç®¡ç†æœºåˆ¶**
   - åŒå±‚çŠ¶æ€æ¶æ„ï¼šleft_sideï¼ˆé™æ€ï¼‰+ right_sideï¼ˆåŠ¨æ€ï¼‰
   - æ™ºèƒ½çš„çŠ¶æ€æ›´æ–°å’Œé•¿åº¦æ§åˆ¶
   - ä¿¡æ¯æ©ç æœºåˆ¶ï¼Œæ”¯æŒå¼ºåŒ–å­¦ä¹ è®­ç»ƒ

4. **GPUä¼˜åŒ–å¤„ç†**
   - `_generate_with_gpu_padding()`: æ™ºèƒ½çš„å¤šGPUæ‰¹æ¬¡å¤„ç†
   - è‡ªåŠ¨å¡«å……æœºåˆ¶ï¼Œè§£å†³GPUæ•°é‡å¯¹é½é—®é¢˜
   - å†…å­˜ç®¡ç†å’Œæ€§èƒ½ä¼˜åŒ–

#### æŠ€æœ¯åˆ›æ–°ç‚¹ï¼š
- **æ™ºèƒ½å†³ç­–æœºåˆ¶**ï¼šLLMè‡ªä¸»å†³å®šä½•æ—¶æœç´¢ã€ä½•æ—¶å›ç­”
- **æ‰¹é‡å¤„ç†ä¼˜åŒ–**ï¼šæœç´¢æŸ¥è¯¢çš„æ‰¹é‡æ”¶é›†å’Œæ‰§è¡Œ
- **å®¹é”™æœºåˆ¶**ï¼šå¯¹æ— æ•ˆåŠ¨ä½œçš„æ™ºèƒ½åé¦ˆå’ŒæŒ‡å¯¼
- **ç»Ÿè®¡è·Ÿè¸ª**ï¼šè¯¦ç»†çš„äº¤äº’è¿‡ç¨‹è®°å½•å’Œåˆ†æ

### 2.2 TensorHelperï¼ˆå¼ é‡æ“ä½œå·¥å…·ç±»ï¼‰

`TensorHelper` æä¾›äº†é«˜æ•ˆçš„æ“ä½œåºåˆ—æ•°æ®çš„å·¥å…·å‡½æ•°ï¼š

#### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼š

1. **é•¿åº¦ä¼˜åŒ–ç®¡ç†**
   - `cut_to_effective_len()`: åŠ¨æ€è£å‰ªåˆ°æœ‰æ•ˆé•¿åº¦ï¼Œå‡å°‘æ— æ•ˆè®¡ç®—
   - æ”¯æŒ left/right åŒå‘è£å‰ªï¼Œçµæ´»é€‚é…ä¸åŒåœºæ™¯

2. **å¡«å……ç»“æ„è½¬æ¢**
   - `convert_pad_structure()`: æ™ºèƒ½çš„å¡«å……ä½ç½®è½¬æ¢
   - æ”¯æŒå·¦å¡«å……å’Œå³å¡«å……ï¼Œé€‚é…ä¸åŒæ¨¡å‹éœ€æ±‚

3. **åºåˆ—æ•°æ®ç”Ÿæˆ**
   - `create_attention_mask()`: è‡ªåŠ¨ç”Ÿæˆæ³¨æ„åŠ›æ©ç 
   - `create_position_ids()`: åˆ›å»ºä½ç½®ç¼–ç ç´¢å¼•

4. **æ‰¹æ¬¡çº§åˆ«å¤„ç†**
   - `concatenate_with_padding()`: å¼ é‡æ‹¼æ¥ä¸å¡«å……ä¸€ä½“åŒ–
   - `_example_level_pad()`: ç¤ºä¾‹çº§åˆ«çš„æ™ºèƒ½å¡«å……

## 3. Search å­æ¨¡å—è¯¦ç»†åˆ†æ

`search` å­æ¨¡å—æ˜¯ç³»ç»Ÿçš„**çŸ¥è¯†æ£€ç´¢å¼•æ“**ï¼Œæä¾›äº†å¤šç§æ£€ç´¢æ–¹æ³•çš„ç»Ÿä¸€å®ç°ã€‚

### 3.1 æ ¸å¿ƒæ£€ç´¢æ¶æ„ï¼ˆretrieval.pyï¼‰

#### åŸºç¡€ç»„ä»¶è®¾è®¡

1. **Encoderç±» - æ™ºèƒ½ç¼–ç å™¨**
   - æ”¯æŒå¤šç§ç¼–ç æ¨¡å‹ï¼šE5ã€BGEã€DPRç­‰
   - æ¨¡å‹ç‰¹å®šçš„å‰ç¼€å¤„ç†ï¼š`query: `ã€`passage: `ç­‰
   - çµæ´»çš„æ± åŒ–ç­–ç•¥ï¼šmeanã€clsã€poolerä¸‰ç§æ–¹å¼
   - è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼šCPU/GPUæ•°æ®æµè½¬ä¼˜åŒ–

2. **BaseRetrieveræŠ½è±¡åŸºç±»**
   - ç»Ÿä¸€çš„æ£€ç´¢æ¥å£è®¾è®¡
   - æ”¯æŒå•æŸ¥è¯¢å’Œæ‰¹é‡æŸ¥è¯¢
   - å¯é€‰çš„åˆ†æ•°è¿”å›æœºåˆ¶

#### å…·ä½“æ£€ç´¢å™¨å®ç°

3. **BM25Retriever - ç¨€ç–æ£€ç´¢**
   - åŸºäºPyseriniçš„Luceneæœç´¢å¼•æ“
   - æ™ºèƒ½æ–‡æ¡£å†…å®¹æ£€æµ‹ï¼šç´¢å¼•å†…å«vså¤–éƒ¨è¯­æ–™
   - çµæ´»çš„æ‰¹é‡å¤„ç†æ¡†æ¶

4. **DenseRetriever - å¯†é›†æ£€ç´¢**
   - åŸºäºFAISSçš„é«˜æ€§èƒ½å‘é‡æœç´¢
   - å¤šGPUæ”¯æŒï¼šè‡ªåŠ¨GPUå†…å­˜ç®¡ç†å’Œè´Ÿè½½å‡è¡¡
   - æ‰¹é‡ç¼–ç ä¼˜åŒ–ï¼šåˆ†æ‰¹å¤„ç†å‡å°‘å†…å­˜å³°å€¼

### 3.2 å¾®æœåŠ¡æ£€ç´¢æ¶æ„ï¼ˆretrieval_server.pyï¼‰

#### æœåŠ¡å±‚è®¾è®¡

1. **FastAPIå¾®æœåŠ¡æ¶æ„**
   - RESTful APIè®¾è®¡ï¼š`POST /retrieve` ç«¯ç‚¹
   - ç»Ÿä¸€çš„è¯·æ±‚/å“åº”æ ¼å¼ï¼šPydanticæ¨¡å‹éªŒè¯
   - æ‰¹é‡æŸ¥è¯¢æ”¯æŒï¼šä¸€æ¬¡å¤„ç†å¤šä¸ªæŸ¥è¯¢è¯·æ±‚

2. **é…ç½®ç®¡ç†ç³»ç»Ÿ**
   - çµæ´»çš„å‚æ•°é…ç½®ï¼šæ”¯æŒBM25å’Œå¯†é›†æ£€ç´¢
   - è¿è¡Œæ—¶å‚æ•°è¦†ç›–ï¼šè¯·æ±‚çº§topkå’Œåˆ†æ•°è¿”å›æ§åˆ¶
   - é»˜è®¤å€¼å›é€€æœºåˆ¶ï¼šç¡®ä¿æœåŠ¡ç¨³å®šæ€§

3. **æ€§èƒ½ä¼˜åŒ–ç‰¹æ€§**
   - å†…å­˜ç®¡ç†ï¼šåŠæ—¶çš„GPUç¼“å­˜æ¸…ç†
   - æ‰¹é‡å¤„ç†ä¼˜åŒ–ï¼šåˆ†æ‰¹ç¼–ç å’Œæ£€ç´¢
   - å“åº”æ ¼å¼åŒ–ï¼šçµæ´»çš„æ–‡æ¡£å’Œåˆ†æ•°ç»„åˆ

### 3.3 å…¶ä»–æ£€ç´¢æœåŠ¡å™¨å®ç°

#### Googleæœç´¢æœåŠ¡å™¨ï¼ˆgoogle_search_server.pyï¼‰

1. **åœ¨çº¿æœç´¢åŠŸèƒ½**
   - Google Custom Search APIé›†æˆ
   - å¼‚æ­¥ç½‘é¡µå†…å®¹æŠ“å–ï¼šå¹¶å‘æ§åˆ¶æå‡æ•ˆç‡
   - æ™ºèƒ½å†…å®¹æå–ï¼šBeautifulSoupè§£æç½‘é¡µ
   - å®¹é”™æœºåˆ¶ï¼šè¶…æ—¶å’Œå¼‚å¸¸å¤„ç†

2. **å†…å®¹å¤„ç†ä¼˜åŒ–**
   - æœç´¢æŸ¥è¯¢å‡€åŒ–ï¼šç‰¹æ®Šå­—ç¬¦å¤„ç†
   - ç‰‡æ®µä¸Šä¸‹æ–‡æå–ï¼šæ™ºèƒ½å®šä½ç›¸å…³æ®µè½
   - ç”¨æˆ·ä»£ç†è½®æ¢ï¼šé¿å…åçˆ¬è™«é™åˆ¶

#### é‡æ’åºæœåŠ¡å™¨ï¼ˆrerank_server.pyï¼‰

1. **CrossEncoderé‡æ’åº**
   - ç¥ç»é‡æ’åºæ¨¡å‹ï¼šåŸºäºSentenceTransformers
   - æŸ¥è¯¢-æ–‡æ¡£ç›¸å…³æ€§ç²¾ç¡®è®¡ç®—
   - æ‰¹é‡å¤„ç†ä¼˜åŒ–ï¼šæ”¯æŒå¤šæŸ¥è¯¢å¹¶è¡Œå¤„ç†

2. **æ’åºç»“æœå¤„ç†**
   - åˆ†æ•°å½’ä¸€åŒ–ï¼šç»Ÿä¸€çš„åˆ†æ•°æ ¼å¼
   - TopKæˆªå–ï¼šçµæ´»çš„è¿”å›æ•°é‡æ§åˆ¶
   - æ–‡æ¡£æ ¼å¼è½¬æ¢ï¼šä¿æŒæ•°æ®æ ¼å¼ä¸€è‡´æ€§

## 4. Search-R1 æ¨¡å—åä½œå…³ç³»ä¸æ•°æ®æµæ€»ç»“

### 4.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Search-R1 æ•´ä½“æ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTPè¯·æ±‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  LLMGeneration   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Retrieval Services  â”‚  â”‚
â”‚  â”‚    Manager       â”‚                â”‚  (å¾®æœåŠ¡æ¶æ„)        â”‚  â”‚
â”‚  â”‚                  â”‚                â”‚                      â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚æ¨ç†-æœç´¢åè°ƒ  â”‚ â”‚                â”‚ â”‚ Local Retrieval  â”‚ â”‚  â”‚
â”‚  â”‚ â”‚å¤šè½®äº¤äº’å¾ªç¯   â”‚ â”‚                â”‚ â”‚ (BM25/Dense)     â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚çŠ¶æ€ç®¡ç†å™¨     â”‚ â”‚                â”‚ â”‚ Online Search   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚(left/right)  â”‚ â”‚                â”‚ â”‚ (Google/SERPAPI) â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ â”‚åŠ¨ä½œè§£æå™¨     â”‚ â”‚                â”‚ â”‚ Rerank Service   â”‚ â”‚  â”‚
â”‚  â”‚ â”‚(search/answer)â”‚ â”‚                â”‚ â”‚ (CrossEncoder)   â”‚ â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ ¸å¿ƒæ•°æ®æµåˆ†æ

#### 4.2.1 æ¨ç†-æœç´¢äº¤äº’æµç¨‹

```python
# æ•°æ®æµç¤ºä¾‹ï¼šä»æŸ¥è¯¢åˆ°å®Œæ•´å“åº”
Query: "What is the capital of France?"

1. LLMGenerationManager åˆå§‹åŒ–
   â””â”€ original_left_side = {input_ids: "What is the capital..."}
   â””â”€ original_right_side = {responses: [], responses_with_info_mask: []}

2. ç¬¬ä¸€è½®æ¨ç†
   â””â”€ LLMç”Ÿæˆ: "<search>capital of France</search>"
   â””â”€ åŠ¨ä½œè§£æ: action="search", content="capital of France"

3. æ£€ç´¢æ‰§è¡Œ
   â””â”€ HTTPè¯·æ±‚: POST /retrieve {"queries": ["capital of France"], "topk": 3}
   â””â”€ æ£€ç´¢æœåŠ¡: BM25/Denseæ£€ç´¢è¿”å›ç›¸å…³æ–‡æ¡£
   â””â”€ ç»“æœæ ¼å¼åŒ–: "Doc 1(Title: France) Paris is the capital..."

4. çŠ¶æ€æ›´æ–°
   â””â”€ next_obs = "\n\n<information>Paris is the capital...</information>\n\n"
   â””â”€ original_right_side æ›´æ–°æœç´¢ç»“æœ
   â””â”€ rollings çŠ¶æ€æ›´æ–°ç”¨äºä¸‹ä¸€è½®ç”Ÿæˆ

5. ç¬¬äºŒè½®æ¨ç†
   â””â”€ LLMåŸºäºæœç´¢ç»“æœç”Ÿæˆ: "<answer>Paris is the capital of France.</answer>"
   â””â”€ åŠ¨ä½œè§£æ: action="answer", done=True

6. æœ€ç»ˆè¾“å‡ºç»„è£…
   â””â”€ left_side + right_side = å®Œæ•´çš„æ¨ç†-æœç´¢å†å²
   â””â”€ DataProto æ ¼å¼è¿”å›ç»™ VERL æ¡†æ¶
```

#### 4.2.2 å¾®æœåŠ¡è°ƒç”¨é“¾

```
LLMGenerationManager
     â”‚ HTTP POST /retrieve
     â–¼
Retrieval Server (Port 8000)
     â”‚
     â”œâ”€â”€ BM25æ£€ç´¢: Pyserini + Lucene
     â”œâ”€â”€ Denseæ£€ç´¢: FAISS + Transformerç¼–ç å™¨
     â””â”€â”€ å¯é€‰: HTTP POST /rerank
         â–¼
     Rerank Server (Port 6980)
     â””â”€â”€ CrossEncoderé‡æ’åº
```

### 4.3 æ–‡ä»¶åä½œå…³ç³»

#### 4.3.1 æ ¸å¿ƒåä½œæ¨¡å¼

1. **LLM Agent ä½œä¸ºåè°ƒä¸­æ¢**
   - `generation.py`: ç»Ÿä¸€çš„æ¨ç†-æœç´¢åè°ƒé€»è¾‘
   - `tensor_helper.py`: é«˜æ•ˆçš„å¼ é‡æ“ä½œå·¥å…·
   - é€šè¿‡HTTP APIä¸æ£€ç´¢æœåŠ¡è§£è€¦

2. **Search Services ä½œä¸ºä¸“ä¸šæœåŠ¡**
   - `retrieval_server.py`: ä¸»è¦æ£€ç´¢æœåŠ¡å…¥å£
   - `google_search_server.py`: åœ¨çº¿æœç´¢è¡¥å……
   - `rerank_server.py`: ç²¾ç»†åŒ–é‡æ’åºæœåŠ¡

3. **æ•°æ®åè®®ç»Ÿä¸€**
   - ç»Ÿä¸€çš„è¯·æ±‚/å“åº”æ ¼å¼
   - æ ‡å‡†åŒ–çš„æ–‡æ¡£å†…å®¹ç»“æ„
   - ä¸€è‡´çš„é”™è¯¯å¤„ç†æœºåˆ¶

#### 4.3.2 é…ç½®ä¸æ‰©å±•æœºåˆ¶

1. **é…ç½®é©±åŠ¨çš„è®¾è®¡**
   ```yaml
   # ç»Ÿä¸€é…ç½®ç¤ºä¾‹
   search_url: "http://localhost:8000"
   topk: 5
   retrieval_method: "e5"  # æˆ– "bm25"
   ```

2. **å·¥å‚æ¨¡å¼è‡ªåŠ¨é€‰æ‹©**
   ```python
   def get_retriever(config):
       if config.retrieval_method == "bm25":
           return BM25Retriever(config)
       else:
           return DenseRetriever(config)
   ```

### 4.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 4.4.1 å†…å­˜ç®¡ç†ä¼˜åŒ–

1. **GPUå†…å­˜ç®¡ç†**
   - åŠæ—¶æ¸…ç†ï¼š`torch.cuda.empty_cache()`
   - åˆ†æ‰¹å¤„ç†ï¼šé¿å…å¤§æ‰¹æ¬¡å†…å­˜å³°å€¼
   - æ•°æ®ç±»å‹ä¼˜åŒ–ï¼šFP16æ”¯æŒ

2. **ç¼“å­˜ç­–ç•¥**
   - æ¨¡å‹å¸¸é©»å†…å­˜ï¼šé¿å…é‡å¤åŠ è½½
   - ç´¢å¼•é¢„åŠ è½½ï¼šFAISSç´¢å¼•ä¸€æ¬¡åŠ è½½ï¼Œå¤šæ¬¡ä½¿ç”¨
   - è¿æ¥æ± å¤ç”¨ï¼šHTTPè¿æ¥å¤ç”¨

#### 4.4.2 å¹¶å‘å¤„ç†ä¼˜åŒ–

1. **å¼‚æ­¥å¹¶å‘**
   - ç½‘é¡µæŠ“å–ï¼š`asyncio` + `aiohttp`
   - ä¿¡å·é‡æ§åˆ¶ï¼šé˜²æ­¢è¿‡è½½
   - è¶…æ—¶æœºåˆ¶ï¼šé¿å…é•¿æ—¶é—´é˜»å¡

2. **æ‰¹é‡å¤„ç†**
   - æŸ¥è¯¢æ‰¹é‡ç¼–ç ï¼šGPUå¹¶è¡Œè®¡ç®—
   - ç´¢å¼•æ‰¹é‡æœç´¢ï¼šå‡å°‘I/Oå¼€é”€
   - ç»“æœæ‰¹é‡ç»„è£…ï¼šæå‡ååé‡

## æ€»ç»“

Search-R1 æ–‡ä»¶å¤¹æ˜¯ä¸€ä¸ªè®¾è®¡ç²¾è‰¯çš„**æ™ºèƒ½æ£€ç´¢ä¸æ¨ç†ç³»ç»Ÿ**ï¼Œä¸»è¦åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒå­æ¨¡å—ï¼š

### ğŸ¯ æ ¸å¿ƒä½œç”¨ä¸å®šä½

1. **æ™ºèƒ½æ¨ç†åè°ƒå™¨**ï¼šç®¡ç†è¯­è¨€æ¨¡å‹ä¸å¤–éƒ¨çŸ¥è¯†æºçš„å¤æ‚äº¤äº’
2. **ç»Ÿä¸€æ£€ç´¢æœåŠ¡**ï¼šæä¾›å¤šç§æ£€ç´¢æ–¹æ³•çš„ä¸“ä¸šåŒ–æœåŠ¡
3. **å¾®æœåŠ¡åŸºç¡€è®¾æ–½**ï¼šä¸ºå¤§è§„æ¨¡å¼ºåŒ–å­¦ä¹ è®­ç»ƒæä¾›ç¨³å®šæ”¯æ’‘

### ğŸ—ï¸ æ¶æ„è®¾è®¡äº®ç‚¹

1. **åˆ†å±‚æŠ½è±¡è®¾è®¡**ï¼šæ¨ç†å±‚ä¸æ£€ç´¢å±‚èŒè´£æ¸…æ™°åˆ†ç¦»
2. **çŠ¶æ€ç®¡ç†æœºåˆ¶**ï¼šåŒå±‚çŠ¶æ€æ¶æ„æ”¯æŒå¤æ‚å¤šè½®æ¨ç†
3. **å¾®æœåŠ¡æ¶æ„**ï¼šæ£€ç´¢æœåŠ¡ç‹¬ç«‹éƒ¨ç½²ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
4. **ç»Ÿä¸€æ•°æ®åè®®**ï¼šæ ‡å‡†åŒ–çš„æ¥å£å’Œæ•°æ®æ ¼å¼

### ğŸš€ æŠ€æœ¯åˆ›æ–°ç‚¹

1. **æ¨ç†-æœç´¢-å¼ºåŒ–å­¦ä¹ ä¸‰ä½ä¸€ä½“**ï¼šå®ç°çœŸæ­£çš„å·¥å…·å¢å¼ºæ¨ç†
2. **å¤šç­–ç•¥æ£€ç´¢èåˆ**ï¼šBM25ã€å¯†é›†æ£€ç´¢ã€åœ¨çº¿æœç´¢çš„ç»Ÿä¸€æ¥å£
3. **æ™ºèƒ½èµ„æºç®¡ç†**ï¼šGPUå†…å­˜ä¼˜åŒ–ã€å¼‚æ­¥å¹¶å‘ã€æ‰¹é‡å¤„ç†
4. **é…ç½®é©±åŠ¨æ‰©å±•**ï¼šæ’ä»¶åŒ–çš„æ¶æ„è®¾è®¡ï¼Œæ˜“äºåŠŸèƒ½æ‰©å±•

### ğŸ“ æ–‡ä»¶åŠŸèƒ½æ€»è§ˆ

#### LLM Agent å­æ¨¡å—
- `generation.py`ï¼šæ ¸å¿ƒåè°ƒæ§åˆ¶å™¨ï¼Œç®¡ç†å¤šè½®æ¨ç†-æœç´¢å¾ªç¯
- `tensor_helper.py`ï¼šé«˜æ•ˆå¼ é‡æ“ä½œå·¥å…·ï¼Œæä¾›åºåˆ—æ•°æ®å¤„ç†èƒ½åŠ›

#### Search å­æ¨¡å—
- `retrieval.py`ï¼šæ£€ç´¢å™¨åŸºç±»å’Œå…·ä½“å®ç°ï¼Œæ”¯æŒBM25å’Œå¯†é›†æ£€ç´¢
- `retrieval_server.py`ï¼šæ£€ç´¢å¾®æœåŠ¡ï¼Œæä¾›HTTP APIæ¥å£
- `google_search_server.py`ï¼šåœ¨çº¿æœç´¢æœåŠ¡ï¼Œé›†æˆGoogleæœç´¢API
- `rerank_server.py`ï¼šé‡æ’åºæœåŠ¡ï¼ŒåŸºäºCrossEncoderç²¾ç¡®æ’åº
- å…¶ä»–è¾…åŠ©æ–‡ä»¶ï¼šç´¢å¼•æ„å»ºã€è¯·æ±‚å®šä¹‰ã€æœåŠ¡å¯åŠ¨è„šæœ¬

è¿™ä¸ªæ¨¡å—çš„è®¾è®¡å……åˆ†ä½“ç°äº†**å·¥ç¨‹åŒ–æ€ç»´**å’Œ**æ¶æ„å‰ç»æ€§**ï¼Œä¸ºæ„å»ºå¤æ‚çš„æ™ºèƒ½æ¨ç†ç³»ç»Ÿæä¾›äº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚é€šè¿‡æ¨¡å—åŒ–ã€å¾®æœåŠ¡åŒ–çš„è®¾è®¡ï¼Œæ—¢ä¿è¯äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼Œåˆä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•ç•™ä¸‹äº†å……è¶³çš„ç©ºé—´ã€‚

---

### é—®é¢˜ 3
ç”¨æˆ·ï¼šsearch_r1æ˜¯å¦‚ä½•å°†LLMçš„æ¨ç†èƒ½åŠ›ä¸æœç´¢å¼•æ“çš„ä¿¡æ¯è·å–èƒ½åŠ›ç»“åˆï¼Œè¯·ç»“åˆå…·ä½“çš„ç¤ºä¾‹å’Œä»£ç è¿›è¡Œé€æ­¥è®²è§£ã€‚

åŠ©æ‰‹ï¼š# Search-R1 æ¨ç†-æœç´¢ç»“åˆæœºåˆ¶è¯¦ç»†è§£æ

## 1. å…·ä½“é—®é¢˜ç¤ºä¾‹ï¼šé€æ­¥å±•ç¤ºæ¨ç†-æœç´¢ç»“åˆè¿‡ç¨‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå…·ä½“çš„é—®é¢˜æ¥ç†è§£æ•´ä¸ªç»“åˆæœºåˆ¶ï¼š

**ç¤ºä¾‹é—®é¢˜**ï¼š"What was the population of Tokyo in 2020 according to the latest census?"

è¿™æ˜¯ä¸€ä¸ªéœ€è¦å®æ—¶ä¿¡æ¯çš„é—®é¢˜ï¼ŒLLMæœ¬èº«æ— æ³•çŸ¥é“2020å¹´ä¸œäº¬äººå£çš„å…·ä½“æ•°æ®ï¼Œéœ€è¦é€šè¿‡æœç´¢è·å–å‡†ç¡®ä¿¡æ¯ã€‚

### 1.1 æ•´ä½“äº¤äº’æµç¨‹æ¦‚è§ˆ

```
ç”¨æˆ·é—®é¢˜: "What was the population of Tokyo in 2020 according to the latest census?"
    â†“
ç¬¬1è½® - LLMæ¨ç†: è¯†åˆ«éœ€è¦æœç´¢ä¿¡æ¯
    â†“
ç¬¬1è½® - æœç´¢æ‰§è¡Œ: æœç´¢"Tokyo population 2020 census"
    â†“
ç¬¬2è½® - LLMæ¨ç†: åŸºäºæœç´¢ç»“æœç”Ÿæˆç­”æ¡ˆ
    â†“
æœ€ç»ˆç­”æ¡ˆ: "According to the 2020 census, Tokyo's population was approximately 13.96 million people..."
```

### 1.2 é€æ­¥ä»£ç æ¼”ç¤ºï¼šæ¨ç†-æœç´¢ç»“åˆçš„å®Œæ•´æµç¨‹

è®©æˆ‘ä»¬é€šè¿‡å…·ä½“çš„ä»£ç æ‰§è¡Œæµç¨‹æ¥ç†è§£ï¼š

#### æ­¥éª¤1ï¼šåˆå§‹åŒ–çŠ¶æ€è®¾ç½®

```python
# generation.py:223-231 - åˆå§‹åŒ–çŠ¶æ€
def run_llm_loop(self, gen_batch, initial_input_ids: torch.Tensor):
    # åŸå§‹æç¤ºè¯éƒ¨åˆ†ï¼ˆé™æ€ä¸å˜ï¼‰
    original_left_side = {
        'input_ids': initial_input_ids[:, -self.config.max_start_length:]
    }

    # åŠ¨æ€å“åº”éƒ¨åˆ†ï¼ˆé€æ­¥ç´¯ç§¯ï¼‰
    original_right_side = {
        'responses': initial_input_ids[:, []],  # ç©ºçš„å“åº”åºåˆ—
        'responses_with_info_mask': initial_input_ids[:, []]  # å¸¦ä¿¡æ¯æ©ç çš„å“åº”
    }

    # æ´»è·ƒçŠ¶æ€æ©ç ï¼šæ ‡è®°å“ªäº›æ ·æœ¬è¿˜åœ¨è¿›è¡Œæ¨ç†
    active_mask = torch.ones(gen_batch.batch['input_ids'].shape[0], dtype=torch.bool)

    # ç»Ÿè®¡ä¿¡æ¯
    turns_stats = torch.ones(gen_batch.batch['input_ids'].shape[0], dtype=torch.int)
    valid_action_stats = torch.zeros(gen_batch.batch['input_ids'].shape[0], dtype=torch.int)
    valid_search_stats = torch.zeros(gen_batch.batch['input_ids'].shape[0], dtype=torch.int)
```

**æŠ€æœ¯è¦ç‚¹è§£æ**ï¼š
- **åŒå±‚çŠ¶æ€è®¾è®¡**ï¼š`left_side` å­˜å‚¨åŸå§‹é—®é¢˜ï¼Œ`right_side` åŠ¨æ€ç´¯ç§¯æ¨ç†å†å²
- **æ´»è·ƒæ©ç æœºåˆ¶**ï¼š`active_mask` è·Ÿè¸ªå“ªäº›æ ·æœ¬è¿˜éœ€è¦ç»§ç»­æ¨ç†
- **ç»Ÿè®¡è·Ÿè¸ª**ï¼šè®°å½•äº¤äº’è½®æ¬¡ã€æœ‰æ•ˆåŠ¨ä½œå’Œæœç´¢æ¬¡æ•°

#### æ­¥éª¤2ï¼šä¸»äº¤äº’å¾ªç¯å¯åŠ¨

```python
# generation.py:234-246 - ä¸»å¾ªç¯å¼€å§‹
for step in range(self.config.max_turns):  # æœ€å¤šäº¤äº’è½®æ•°é™åˆ¶
    if not active_mask.sum():  # å¦‚æœæ²¡æœ‰æ´»è·ƒæ ·æœ¬ï¼Œæå‰ç»“æŸ
        break

    # åªå¤„ç†æ´»è·ƒçš„æ ·æœ¬ï¼Œæå‡æ•ˆç‡
    rollings_active = DataProto.from_dict({
        k: v[active_mask] for k, v in rollings.batch.items()
    })

    # LLMç”Ÿæˆå“åº”
    gen_output = self._generate_with_gpu_padding(rollings_active)
```

**æŠ€æœ¯è¦ç‚¹è§£æ**ï¼š
- **åŠ¨æ€æ‰¹æ¬¡ä¼˜åŒ–**ï¼šåªå¤„ç†æ´»è·ƒæ ·æœ¬ï¼Œé¿å…æ— æ•ˆè®¡ç®—
- **å¤šGPUé€‚é…**ï¼š`_generate_with_gpu_padding` å¤„ç†GPUæ•°é‡å¯¹é½é—®é¢˜

## 2. LLMGenerationManager æ ¸å¿ƒåè°ƒæœºåˆ¶æ·±åº¦åˆ†æ

### 2.1 åŠ¨ä½œè§£ææœºåˆ¶ï¼šLLMè¾“å‡ºåˆ°å…·ä½“åŠ¨ä½œçš„è½¬æ¢

è®©æˆ‘ä»¬æ·±å…¥åˆ†ææœ€å…³é”®çš„åŠ¨ä½œè§£æéƒ¨åˆ†ï¼š

```python
# generation.py:220-249 - åŠ¨ä½œè§£ææ ¸å¿ƒé€»è¾‘
def postprocess_predictions(self, predictions: List[Any]) -> Tuple[List[int], List[bool]]:
    """
    å°†LLMçš„æ–‡æœ¬è¾“å‡ºè§£æä¸ºå…·ä½“åŠ¨ä½œå’Œå†…å®¹
    """
    actions = []
    contents = []

    for prediction in predictions:
        if isinstance(prediction, str):
            # å…³é”®ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æç»“æ„åŒ–åŠ¨ä½œ
            pattern = r'<(search|answer)>(.*?)</\1>'
            match = re.search(pattern, prediction, re.DOTALL)

            if match:
                content = match.group(2).strip()  # æå–åŠ¨ä½œå†…å®¹
                action = match.group(1)          # æå–åŠ¨ä½œç±»å‹
            else:
                content = ''     # æ— æ•ˆåŠ¨ä½œ
                action = None

        actions.append(action)
        contents.append(content)

    return actions, contents
```

**æŠ€æœ¯äº®ç‚¹è§£æ**ï¼š
1. **ç»“æ„åŒ–è¾“å‡ºè®¾è®¡**ï¼šLLMè¢«è®­ç»ƒç”Ÿæˆç‰¹å®šæ ¼å¼çš„è¾“å‡ºï¼š`<search>æŸ¥è¯¢å†…å®¹</search>` æˆ– `<answer>ç­”æ¡ˆå†…å®¹</answer>`
2. **æ­£åˆ™è¡¨è¾¾å¼è§£æ**ï¼šä½¿ç”¨ `r'<(search|answer)>(.*?)</\1>'` ç²¾ç¡®æå–åŠ¨ä½œç±»å‹å’Œå†…å®¹
3. **å®¹é”™æœºåˆ¶**ï¼šå¯¹æ— æ•ˆæ ¼å¼è¿›è¡Œä¼˜é›…å¤„ç†ï¼Œé¿å…ç³»ç»Ÿå´©æºƒ

## 3. åŠ¨ä½œè§£æå’Œæœç´¢æ‰§è¡Œçš„æŠ€æœ¯å®ç°

### 3.1 åŠ¨ä½œæ‰§è¡Œçš„å®Œæ•´æµç¨‹

è®©æˆ‘ä»¬æ·±å…¥åˆ†æ `execute_predictions` æ–¹æ³•ï¼Œè¿™æ˜¯æ¨ç†-æœç´¢ç»“åˆçš„æ ¸å¿ƒæ‰§è¡Œé€»è¾‘ï¼š

```python
# generation.py:166-218 - åŠ¨ä½œæ‰§è¡Œçš„æ ¸å¿ƒé€»è¾‘
def execute_predictions(self, predictions: List[str], pad_token: str, active_mask=None, do_search=True):
    """
    æ‰§è¡ŒLLMç”Ÿæˆçš„åŠ¨ä½œï¼Œè¿™æ˜¯ç³»ç»Ÿçš„"ç¯å¢ƒ"æ­¥éª¤å‡½æ•°
    """
    # ç¬¬1æ­¥ï¼šè§£æLLMè¾“å‡ºä¸ºå…·ä½“åŠ¨ä½œ
    cur_actions, contents = self.postprocess_predictions(predictions)
    next_obs, dones, valid_action, is_search = [], [], [], []

    # ç¬¬2æ­¥ï¼šæ”¶é›†æ‰€æœ‰æœç´¢æŸ¥è¯¢
    search_queries = [content for action, content in zip(cur_actions, contents) if action == 'search']

    # ç¬¬3æ­¥ï¼šæ‰¹é‡æ‰§è¡Œæœç´¢ï¼ˆå…³é”®ä¼˜åŒ–ï¼‰
    if do_search and search_queries:
        search_results = self.batch_search(search_queries)  # HTTPè¯·æ±‚åˆ°æ£€ç´¢æœåŠ¡
        assert len(search_results) == len(search_queries)
    else:
        search_results = [''] * len(search_queries)

    # ç¬¬4æ­¥ï¼šä¸ºæ¯ä¸ªåŠ¨ä½œç”Ÿæˆå¯¹åº”çš„è§‚å¯Ÿç»“æœ
    for i, (action, active) in enumerate(zip(cur_actions, active_mask)):
        if not active:
            # éæ´»è·ƒæ ·æœ¬ï¼šç›´æ¥è·³è¿‡
            next_obs.append('')
            dones.append(1)
            valid_action.append(0)
            is_search.append(0)
        else:
            if action == 'answer':
                # åŠ¨ä½œï¼šç»™å‡ºæœ€ç»ˆç­”æ¡ˆ
                next_obs.append('')          # ç­”æ¡ˆåä¸éœ€è¦æ–°çš„è§‚å¯Ÿ
                dones.append(1)             # æ ‡è®°ä¸ºå®Œæˆ
                valid_action.append(1)      # æœ‰æ•ˆåŠ¨ä½œ
                is_search.append(0)         # éæœç´¢åŠ¨ä½œ

            elif action == 'search':
                # åŠ¨ä½œï¼šæ‰§è¡Œæœç´¢
                search_result = search_results.pop(0).strip()
                # å…³é”®ï¼šå°†æœç´¢ç»“æœåŒ…è£…ä¸ºç»“æ„åŒ–è§‚å¯Ÿ
                next_obs.append(f'\n\n<information>{search_result}</information>\n\n')
                dones.append(0)             # æœç´¢åç»§ç»­æ¨ç†
                valid_action.append(1)      # æœ‰æ•ˆåŠ¨ä½œ
                is_search.append(1)         # æœç´¢åŠ¨ä½œ

            else:
                # åŠ¨ä½œï¼šæ— æ•ˆæ ¼å¼
                next_obs.append(f'\nMy previous action is invalid. \
If I want to search, I should put the query between <search> and </search>. \
If I want to give the final answer, I should put the answer between <answer> and </answer>. Let me try again.\n')
                dones.append(0)             # ç»§ç»­å°è¯•
                valid_action.append(0)      # æ— æ•ˆåŠ¨ä½œ
                is_search.append(0)         # éæœç´¢åŠ¨ä½œ

    return next_obs, dones, valid_action, is_search
```

**æŠ€æœ¯äº®ç‚¹è§£æ**ï¼š

1. **æ‰¹é‡æœç´¢ä¼˜åŒ–**ï¼šå°†æ‰€æœ‰æœç´¢æŸ¥è¯¢æ”¶é›†åæ‰¹é‡å¤„ç†ï¼Œå‡å°‘HTTPè¯·æ±‚å¼€é”€
2. **çŠ¶æ€æœºè®¾è®¡**ï¼šé€šè¿‡ `dones` æ ‡å¿—æ§åˆ¶äº¤äº’æµç¨‹çš„ç»“æŸ
3. **é”™è¯¯åé¦ˆæœºåˆ¶**ï¼šå¯¹æ— æ•ˆåŠ¨ä½œæä¾›æ˜ç¡®çš„æ ¼å¼æŒ‡å¯¼ï¼Œå¸®åŠ©LLMå­¦ä¹ æ­£ç¡®æ ¼å¼

### 3.2 æœç´¢è¯·æ±‚çš„å…·ä½“å®ç°

è®©æˆ‘ä»¬çœ‹çœ‹æœç´¢æ˜¯å¦‚ä½•å…·ä½“æ‰§è¡Œçš„ï¼š

```python
# generation.py:251-271 - æœç´¢æ‰§è¡Œçš„å…·ä½“å®ç°
def batch_search(self, queries: List[str] = None) -> List[str]:
    """
    æ‰¹é‡æœç´¢æ¥å£ï¼Œè°ƒç”¨å¤–éƒ¨æ£€ç´¢æœåŠ¡
    """
    results = self._batch_search(queries)['result']
    return [self._passages2string(result) for result in results]

def _batch_search(self, queries):
    """
    å†…éƒ¨æœç´¢å®ç°ï¼Œé€šè¿‡HTTP APIè°ƒç”¨æ£€ç´¢æœåŠ¡
    """
    payload = {
        "queries": queries,           # æŸ¥è¯¢åˆ—è¡¨
        "topk": self.config.topk,    # è¿”å›æ–‡æ¡£æ•°é‡
        "return_scores": True        # è¿”å›ç›¸å…³æ€§åˆ†æ•°
    }

    # å…³é”®ï¼šHTTP POSTè¯·æ±‚åˆ°æ£€ç´¢æœåŠ¡å™¨
    return requests.post(self.config.search_url, json=payload).json()

def _passages2string(self, retrieval_result):
    """
    å°†æ£€ç´¢ç»“æœæ ¼å¼åŒ–ä¸ºLLMå¯ç†è§£çš„æ–‡æœ¬æ ¼å¼
    """
    format_reference = ''
    for idx, doc_item in enumerate(retrieval_result):
        content = doc_item['document']['contents']
        title = content.split("\n")[0]
        text = "\n".join(content.split("\n")[1:])
        format_reference += f"Doc {idx+1}(Title: {title}) {text}\n"

    return format_reference
```

**å®é™…HTTPè¯·æ±‚ç¤ºä¾‹**ï¼š
```json
// POST http://localhost:8000/retrieve
{
    "queries": ["Tokyo population 2020 census"],
    "topk": 3,
    "return_scores": true
}

// å“åº”ç¤ºä¾‹
{
    "result": [
        [
            {
                "document": {
                    "contents": "\"Tokyo Population 2020\"\nAccording to the 2020 census, Tokyo's population was approximately 13.96 million people..."
                },
                "score": 0.95
            }
        ]
    ]
}
```

### 3.3 å…·ä½“ç¤ºä¾‹çš„å®Œæ•´æ‰§è¡Œæµç¨‹

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹æ¥ç†è§£æ•´ä¸ªæµç¨‹ï¼š

#### ç¤ºä¾‹ï¼šæŸ¥è¯¢ä¸œäº¬2020å¹´äººå£

**åˆå§‹çŠ¶æ€**ï¼š
```
ç”¨æˆ·é—®é¢˜: "What was the population of Tokyo in 2020 according to the latest census?"
left_side: ["What was the population of Tokyo in 2020 according to the latest census?"]
right_side: []
active_mask: [True]
step: 0
```

**ç¬¬1è½®ï¼šLLMæ¨ç†**ï¼š
```
LLMè¾“å…¥: "What was the population of Tokyo in 2020 according to the latest census?"
LLMè¾“å‡º: "<search>Tokyo population 2020 census data</search>"

è§£æç»“æœ:
- action: "search"
- content: "Tokyo population 2020 census data"
```

**ç¬¬1è½®ï¼šæœç´¢æ‰§è¡Œ**ï¼š
```python
# HTTPè¯·æ±‚åˆ°æ£€ç´¢æœåŠ¡
search_queries = ["Tokyo population 2020 census data"]
search_results = ["Doc 1(Title: Tokyo Population 2020) According to the 2020 census conducted by the Statistics Bureau of Japan, Tokyo's population was approximately 13.96 million people..."]

# ç”Ÿæˆè§‚å¯Ÿ
next_obs = ["\n\n<information>Doc 1(Title: Tokyo Population 2020) According to the 2020 census...</information>\n\n"]
dones = [0]  # ç»§ç»­æ¨ç†
valid_action = [1]  # æœ‰æ•ˆåŠ¨ä½œ
is_search = [1]  # æ˜¯æœç´¢åŠ¨ä½œ
```

**çŠ¶æ€æ›´æ–°**ï¼š
```
left_side: ["What was the population of Tokyo in 2020 according to the latest census?"]
right_side: ["<search>Tokyo population 2020 census data</search>", "\n\n<information>Doc 1...</information>\n\n"]
active_mask: [True]
step: 1
```

**ç¬¬2è½®ï¼šLLMæ¨ç†**ï¼š
```
LLMè¾“å…¥: "What was the population of Tokyo in 2020 according to the latest census? <search>Tokyo population 2020 census data</search> <information>Doc 1...</information>"
LLMè¾“å‡º: "<answer>According to the 2020 census, Tokyo's population was approximately 13.96 million people.</answer>"

è§£æç»“æœ:
- action: "answer"
- content: "According to the 2020 census, Tokyo's population was approximately 13.96 million people."
```

**ç¬¬2è½®ï¼šåŠ¨ä½œæ‰§è¡Œ**ï¼š
```python
# ç­”æ¡ˆåŠ¨ä½œï¼Œæ— éœ€æœç´¢
next_obs = [""]  # ç©ºè§‚å¯Ÿ
dones = [1]  # æ ‡è®°å®Œæˆ
valid_action = [1]  # æœ‰æ•ˆåŠ¨ä½œ
is_search = [0]  # éæœç´¢åŠ¨ä½œ
```

**æœ€ç»ˆè¾“å‡º**ï¼š
```
å®Œæ•´æ¨ç†å†å²:
[
    "What was the population of Tokyo in 2020 according to the latest census?",
    "<search>Tokyo population 2020 census data</search>",
    "\n\n<information>Doc 1(Title: Tokyo Population 2020) According to the 2020 census...</information>\n\n",
    "<answer>According to the 2020 census, Tokyo's population was approximately 13.96 million people.</answer>"
]
```

## 4. çŠ¶æ€ç®¡ç†å’Œå¤šè½®äº¤äº’çš„æŠ€æœ¯ç»†èŠ‚

### 4.1 åŒå±‚çŠ¶æ€ç®¡ç†æœºåˆ¶

Search-R1 é‡‡ç”¨äº†ä¸€ç§åˆ›æ–°çš„åŒå±‚çŠ¶æ€ç®¡ç†æœºåˆ¶ï¼Œè®©æˆ‘è¯¦ç»†åˆ†æå…¶å®ç°ï¼š

```python
# generation.py:223-224 - åŒå±‚çŠ¶æ€åˆå§‹åŒ–
original_left_side = {
    'input_ids': initial_input_ids[:, -self.config.max_start_length:]
}
original_right_side = {
    'responses': initial_input_ids[:, []],  # åŠ¨æ€å“åº”ç´¯ç§¯
    'responses_with_info_mask': initial_input_ids[:, []]  # å¸¦æ©ç çš„å“åº”
}

# generation.py:145-167 - å³ä¾§çŠ¶æ€æ›´æ–°æœºåˆ¶
def _update_right_side(self, right_side: Dict,
                      cur_responses: torch.Tensor,
                      next_obs_ids: torch.Tensor = None):
    """æ›´æ–°å³ä¾§çŠ¶æ€ï¼ˆåŠ¨æ€éƒ¨åˆ†ï¼‰"""
    if next_obs_ids != None:
        responses, responses_with_info_mask = self._info_masked_concatenate_with_padding(
            right_side['responses'],           # ä¹‹å‰çš„å“åº”
            right_side['responses_with_info_mask'],  # ä¹‹å‰çš„æ©ç å“åº”
            cur_responses,                     # å½“å‰ç”Ÿæˆçš„åŠ¨ä½œ
            next_obs_ids,                      # æœç´¢ç»“æœ
            pad_to_left=False
        )
    else:
        # åªæœ‰åŠ¨ä½œï¼Œæ— æœç´¢ç»“æœ
        responses, responses_with_info_mask = self._info_masked_concatenate_with_padding(
            right_side['responses'],
            right_side['responses_with_info_mask'],
            cur_responses,
            pad_to_left=False
        )

    # é•¿åº¦æ§åˆ¶
    effective_len = self.tensor_fn.create_attention_mask(responses).sum(dim=1).max()
    max_len = min(self.config.max_prompt_length, effective_len)

    return {
        'responses': responses[:, :max_len],
        'responses_with_info_mask': responses_with_info_mask[:, :max_len]
    }
```

**åŒå±‚çŠ¶æ€çš„æŠ€æœ¯ä¼˜åŠ¿**ï¼š

1. **é™æ€ä¸åŠ¨æ€åˆ†ç¦»**ï¼š`left_side` å­˜å‚¨ä¸å˜çš„åŸå§‹é—®é¢˜ï¼Œ`right_side` åŠ¨æ€ç´¯ç§¯æ¨ç†è¿‡ç¨‹
2. **æ©ç æœºåˆ¶**ï¼š`responses_with_info_mask` ä¸ºå¼ºåŒ–å­¦ä¹ æä¾›æŸå¤±è®¡ç®—çš„ç²¾ç¡®æ§åˆ¶
3. **å†…å­˜ä¼˜åŒ–**ï¼šé€šè¿‡é•¿åº¦è£å‰ªé¿å…æ— é™å¢é•¿ï¼Œæ§åˆ¶å†…å­˜ä½¿ç”¨

### 4.2 ä¿¡æ¯æ©ç æœºåˆ¶

è®©æˆ‘ä»¬æ·±å…¥åˆ†æåˆ›æ–°çš„ä¿¡æ¯æ©ç æœºåˆ¶ï¼š

```python
# generation.py:120-143 - ä¿¡æ¯æ©ç çš„æ ¸å¿ƒå®ç°
def _info_masked_concatenate_with_padding(self,
            prompt: torch.Tensor,
            prompt_with_mask: torch.Tensor,
            response: torch.Tensor,
            info: torch.Tensor = None,
            pad_to_left: bool = True):
    """è¿æ¥å¼ é‡å¹¶å¤„ç†å¡«å……ï¼Œç‰¹åˆ«åˆ›å»ºä¿¡æ¯æ©ç è¦†ç›–ä¿¡æ¯å—"""
    pad_id = self.tokenizer.pad_token_id
    tensors = [prompt, response]
    tensors_with_mask = [prompt_with_mask, response]

    if info is not None:
        tensors.append(info)  # æ·»åŠ å®é™…æœç´¢ç»“æœ
        # å…³é”®ï¼šä¸ºæœç´¢ç»“æœåˆ›å»ºæ©ç 
        info_mask = torch.full(info.size(), pad_id, dtype=info.dtype, device=info.device)
        tensors_with_mask.append(info_mask)  # ç”¨æ©ç æ›¿ä»£å®é™…ä¿¡æ¯

    # å¼ é‡è¿æ¥
    concatenated = torch.cat(tensors, dim=1)
    concatenated_with_info = torch.cat(tensors_with_mask, dim=1)

    # å¡«å……å¤„ç†
    mask = concatenated != pad_id if pad_to_left else concatenated == pad_id
    sorted_indices = mask.to(torch.int64).argsort(dim=1, stable=True)
    padded_tensor = concatenated.gather(1, sorted_indices)
    padded_tensor_with_info = concatenated_with_info.gather(1, sorted_indices)

    return padded_tensor, padded_tensor_with_info
```

**ä¿¡æ¯æ©ç çš„æŠ€æœ¯æ„ä¹‰**ï¼š

1. **å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–**ï¼šé€šè¿‡ `info_mask` æ§åˆ¶å“ªäº›tokenå‚ä¸æŸå¤±è®¡ç®—
2. **è®­ç»ƒç¨³å®šæ€§**ï¼šé¿å…æ¨¡å‹è¿‡åº¦ä¾èµ–æœç´¢ç»“æœï¼Œä¿æŒæ¨ç†èƒ½åŠ›
3. **çµæ´»æ§åˆ¶**ï¼šå¯ä»¥é’ˆå¯¹ä¸åŒè®­ç»ƒé˜¶æ®µè°ƒæ•´æ©ç ç­–ç•¥

### 4.3 å¤šè½®äº¤äº’çš„å®Œæ•´æ•°æ®æµ

è®©æˆ‘é€šè¿‡ä»£ç å±•ç¤ºå¤šè½®äº¤äº’çš„å®Œæ•´æ•°æ®æµï¼š

```python
# generation.py:248-289 - å¤šè½®äº¤äº’çš„æ ¸å¿ƒå¾ªç¯
for step in range(self.config.max_turns):
    # 1. LLMç”ŸæˆåŠ¨ä½œ
    gen_output = self._generate_with_gpu_padding(rollings_active)
    responses_ids, responses_str = self._postprocess_responses(gen_output.batch['responses'])

    # 2. æ‰§è¡ŒåŠ¨ä½œå¹¶è·å–è§‚å¯Ÿ
    next_obs, dones, valid_action, is_search = self.execute_predictions(
        responses_str, self.tokenizer.pad_token, active_mask
    )

    # 3. å¤„ç†è§‚å¯Ÿç»“æœ
    next_obs_ids = self._process_next_obs(next_obs)

    # 4. æ›´æ–°æ»šåŠ¨çŠ¶æ€ï¼ˆç”¨äºä¸‹ä¸€è½®ç”Ÿæˆï¼‰
    rollings = self._update_rolling_state(
        rollings,      # å®Œæ•´çš„å†å²ä¸Šä¸‹æ–‡
        responses_ids, # å½“å‰åŠ¨ä½œ
        next_obs_ids   # æœç´¢ç»“æœ
    )

    # 5. æ›´æ–°å³ä¾§çŠ¶æ€ï¼ˆæœ€ç»ˆè¾“å‡ºæ„å»ºï¼‰
    original_right_side = self._update_right_side(
        original_right_side,
        responses_ids,
        next_obs_ids
    )

    # 6. æ›´æ–°æ´»è·ƒæ©ç 
    curr_active_mask = torch.tensor([not done for done in dones], dtype=torch.bool)
    active_mask = active_mask * curr_active_mask

    # 7. ç»Ÿè®¡æ›´æ–°
    turns_stats[curr_active_mask] += 1
    valid_action_stats += torch.tensor(valid_action, dtype=torch.int)
    valid_search_stats += torch.tensor(is_search, dtype=torch.int)
```

**å¤šè½®äº¤äº’çš„æŠ€æœ¯ç‰¹ç‚¹**ï¼š

1. **çŠ¶æ€æ¼”è¿›**ï¼šæ¯è½®éƒ½åŸºäºå®Œæ•´å†å²è¿›è¡Œæ¨ç†ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§
2. **åŠ¨æ€æ‰¹æ¬¡**ï¼šæ´»è·ƒæ©ç æœºåˆ¶å‡å°‘æ— æ•ˆè®¡ç®—ï¼Œæå‡æ•ˆç‡
3. **ç»Ÿè®¡è·Ÿè¸ª**ï¼šè¯¦ç»†è®°å½•äº¤äº’è¿‡ç¨‹ï¼Œä¾¿äºåˆ†æå’Œè°ƒè¯•

### 4.4 å…·ä½“ç¤ºä¾‹ï¼šå¤šè½®æœç´¢çš„å¤æ‚åœºæ™¯

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªéœ€è¦å¤šè½®æœç´¢çš„å¤æ‚ä¾‹å­ï¼š

**é—®é¢˜**ï¼š"Compare the GDP growth rates of China and the United States from 2019 to 2021, and analyze the impact of COVID-19"

**æ‰§è¡Œæµç¨‹**ï¼š

#### ç¬¬1è½®ï¼šåˆå§‹æœç´¢
```
LLMè¾“å‡º: "<search>China GDP growth rate 2019 2020 2021 COVID-19 impact</search>"
æœç´¢ç»“æœ: "China's GDP growth: 2019: 6.0%, 2020: 2.3%, 2021: 8.1%"
çŠ¶æ€æ›´æ–°: å³ä¾§çŠ¶æ€æ·»åŠ æœç´¢åŠ¨ä½œå’Œç»“æœ
```

#### ç¬¬2è½®ï¼šè¡¥å……æœç´¢
```
LLMè¾“å‡º: "<search>United States GDP growth rate 2019 2020 2021 COVID-19 pandemic</search>"
æœç´¢ç»“æœ: "US GDP growth: 2019: 2.3%, 2020: -3.4%, 2021: 5.7%"
çŠ¶æ€æ›´æ–°: å³ä¾§çŠ¶æ€ç»§ç»­ç´¯ç§¯
```

#### ç¬¬3è½®ï¼šæœ€ç»ˆç­”æ¡ˆ
```
LLMè¾“å‡º: "<answer>Based on the search results, China maintained positive growth throughout 2019-2021, while the US experienced a contraction in 2020...</answer>"
çŠ¶æ€æ›´æ–°: å®Œæˆæ¨ç†ï¼Œæ ‡è®°done=True
```

**æœ€ç»ˆçŠ¶æ€**ï¼š
```python
final_output = {
    'input_ids': [
        question_tokens,
        search1_tokens,
        info1_tokens,
        search2_tokens,
        info2_tokens,
        answer_tokens
    ],
    'attention_mask': [...],
    'info_mask': [
        question_mask,    # å‚ä¸æŸå¤±è®¡ç®—
        search1_mask,     # å‚ä¸æŸå¤±è®¡ç®—
        info1_mask,       # ä¸å‚ä¸æŸå¤±è®¡ç®—ï¼ˆå¤–éƒ¨çŸ¥è¯†ï¼‰
        search2_mask,     # å‚ä¸æŸå¤±è®¡ç®—
        info2_mask,       # ä¸å‚ä¸æŸå¤±è®¡ç®—ï¼ˆå¤–éƒ¨çŸ¥è¯†ï¼‰
        answer_mask       # å‚ä¸æŸå¤±è®¡ç®—
    ]
}
```

## æ€»ç»“ï¼šSearch-R1 æ¨ç†-æœç´¢ç»“åˆçš„æ ¸å¿ƒåˆ›æ–°

é€šè¿‡ä»¥ä¸Šè¯¦ç»†åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡º Search-R1 å°† LLM æ¨ç†èƒ½åŠ›ä¸æœç´¢å¼•æ“ä¿¡æ¯è·å–èƒ½åŠ›ç»“åˆçš„æ ¸å¿ƒæœºåˆ¶ï¼š

### ğŸ¯ **æ¶æ„è®¾è®¡åˆ›æ–°**

1. **åˆ†å±‚çŠ¶æ€ç®¡ç†**
   - é™æ€å±‚ï¼ˆleft_sideï¼‰ï¼šå­˜å‚¨ä¸å˜çš„åŸå§‹é—®é¢˜
   - åŠ¨æ€å±‚ï¼ˆright_sideï¼‰ï¼šç´¯ç§¯æ¨ç†-æœç´¢å†å²
   - æ©ç å±‚ï¼ˆinfo_maskï¼‰ï¼šæ§åˆ¶å¼ºåŒ–å­¦ä¹ çš„æŸå¤±è®¡ç®—

2. **æ™ºèƒ½åè°ƒæœºåˆ¶**
   - LLMGenerationManager ä½œä¸ºåè°ƒä¸­æ¢
   - ç»“æ„åŒ–åŠ¨ä½œæ ¼å¼ï¼š`<search>æŸ¥è¯¢</search>` å’Œ `<answer>ç­”æ¡ˆ</answer>`
   - è‡ªä¸»å¯¼èˆªï¼šLLM è‡ªä¸»å†³å®šä½•æ—¶æœç´¢ã€ä½•æ—¶å›ç­”

### ğŸš€ **æŠ€æœ¯å®ç°äº®ç‚¹**

1. **é«˜æ•ˆæ‰¹é‡å¤„ç†**
   - æœç´¢æŸ¥è¯¢æ‰¹é‡æ”¶é›†ï¼Œå‡å°‘HTTPå¼€é”€
   - åŠ¨æ€æ‰¹æ¬¡ä¼˜åŒ–ï¼šåªå¤„ç†æ´»è·ƒæ ·æœ¬
   - å¤šGPUé€‚é…ï¼šæ™ºèƒ½å¡«å……æœºåˆ¶

2. **ä¿¡æ¯æ©ç æœºåˆ¶**
   - åŒºåˆ†æ¨¡å‹æ¨ç†å’Œå¤–éƒ¨çŸ¥è¯†
   - å¼ºåŒ–å­¦ä¹ è®­ç»ƒç¨³å®šæ€§
   - çµæ´»çš„æŸå¤±è®¡ç®—æ§åˆ¶

3. **å®¹é”™ä¸åé¦ˆ**
   - æ— æ•ˆåŠ¨ä½œçš„æ ¼å¼æŒ‡å¯¼
   - çŠ¶æ€æœºæ§åˆ¶æµç¨‹ç»“æŸ
   - å®Œæ•´çš„ç»Ÿè®¡è·Ÿè¸ªæœºåˆ¶

### ğŸ’¡ **å®é™…åº”ç”¨ä»·å€¼**

1. **å·¥å…·å¢å¼ºæ¨ç†**
   - LLM å­¦ä¼šä½¿ç”¨å¤–éƒ¨å·¥å…·
   - å®æ—¶ä¿¡æ¯è·å–èƒ½åŠ›
   - å¤æ‚é—®é¢˜åˆ†è§£è§£å†³

2. **è®­ç»ƒä¼˜åŒ–**
   - å¤šè½®äº¤äº’çš„è½¨è¿¹å­¦ä¹ 
   - æœç´¢ç­–ç•¥çš„ä¼˜åŒ–
   - æ¨ç†èƒ½åŠ›çš„ä¿æŒ

3. **å¯æ‰©å±•æ¶æ„**
   - æ”¯æŒå¤šç§æ£€ç´¢åç«¯
   - çµæ´»çš„åŠ¨ä½œæ‰©å±•
   - æ¨¡å—åŒ–è®¾è®¡

### ğŸ”„ **å®Œæ•´å·¥ä½œæµç¨‹**

```
ç”¨æˆ·é—®é¢˜
    â†“
LLM æ¨ç†å†³ç­–ï¼ˆæœç´¢è¿˜æ˜¯å›ç­”ï¼‰
    â†“
ç»“æ„åŒ–åŠ¨ä½œç”Ÿæˆï¼ˆ<search>/<answer>ï¼‰
    â†“
åŠ¨ä½œè§£æä¸æ‰§è¡Œ
    â†“
æ‰¹é‡æœç´¢è¯·æ±‚ï¼ˆå¦‚æœéœ€è¦ï¼‰
    â†“
ä¿¡æ¯è·å–ä¸æ ¼å¼åŒ–
    â†“
çŠ¶æ€æ›´æ–°ä¸ä¸‹ä¸€è½®å‡†å¤‡
    â†“
æœ€ç»ˆç­”æ¡ˆç”Ÿæˆï¼ˆå¾ªç¯ç›´åˆ° done=Trueï¼‰
```

è¿™ç§è®¾è®¡çœŸæ­£å®ç°äº† **LLM ä½œä¸ºæ€è€ƒå¤§è„‘ï¼Œæœç´¢å¼•æ“ä½œä¸ºçŸ¥è¯†åº“** çš„ååŒå·¥ä½œæ¨¡å¼ï¼Œä¸ºæ„å»ºæ™ºèƒ½æ¨ç†ç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„æŠ€æœ¯åŸºç¡€ã€‚é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„çŠ¶æ€ç®¡ç†ã€åŠ¨ä½œè§£æå’Œä¿¡æ¯æ©ç æœºåˆ¶ï¼Œç³»ç»Ÿæ—¢èƒ½åˆ©ç”¨å¤–éƒ¨çŸ¥è¯†ï¼Œåˆèƒ½ä¿æŒè‡ªèº«çš„æ¨ç†èƒ½åŠ›ï¼Œå®ç°äº†ä¸¤è€…ä¼˜åŠ¿çš„å®Œç¾ç»“åˆã€‚